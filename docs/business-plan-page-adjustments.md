# 商业计划书页面调整建议

## 背景
- 页面位于 `src/app/business-plan/page.tsx`，承载竞价会话、调研报告与智能直生等多入口的商业计划书展示。
- 本次检查发现多处交互与数据流问题，影响用户拿到最终落地指南的体验。
- 目标是在不影响既有架构的前提下，尽快恢复核心功能（生成、导出、分享）并提升可用性。

## 调整要点

### 1. 会话加载流程缺乏完成通知
- **现状**：触发 `/api/business-plan-session?sessionId=...` 后，如果后端尚未生成 `report.guide`，前端只更新进度到 60%，直接返回等待用户手动刷新。
- **调整建议**：
  - 增加轮询或 SSE：在 `report.guide` 为空时以 5~8 秒间隔重新请求，直至拿到成果或超时。
  - 展示提示文案，说明仍在生成中并自动刷新，减少用户困惑。
- **验证**：使用 AI 竞价流程触发一次生成，确认无人工刷新即可收到完整 Guide。

### 2. 智能直生模式导出 / 分享不可用
- **现状**：`handleDownload`、`handleShare` 分别要求 `sessionId` 或 `reportId` 才继续执行；直生模式没有这两个参数，按钮全部失效。
- **调整建议**：
  - 在返回结果时，为直生模式创建一次轻量会话或报告记录，返回 `reportId`。
  - 或前端在无 `reportId`/`sessionId` 时，直接使用当前 `guide` 生成 Markdown/TXT，调用 `/api/documents/download` 时传递后端新建的临时 ID。
- **验证**：直生后立即点击导出/分享，能得到文件或复制链接；刷新页面后仍可通过 `reportId` 访问。

### 3. `useSimplifiedFormat` 参数被写死
- **现状**：即使 URL 指定 `useSimplifiedFormat=false`，前端仍强制传 `true`，导致后端只能走简化流程。
- **调整建议**：
  - 透传查询参数的布尔值，或给 UI 一个选项切换生成深度。
  - 依据不同模式调整进度文案与导出内容提示，避免误导。
- **验证**：在 URL 或 UI 切换生成模式，检查请求载荷与返回内容是否匹配预期。

### 4. 来源徽标文案与真实渠道不符
- **现状**：顶部徽章仅判断 `source === 'marketplace'`，其余全部显示“来自调研报告”。`ai-bidding`、`direct-generation` 均被误标。
- **调整建议**：
  - 扩展来源映射表：`ai-bidding` → “来自竞价对接”、`direct-generation` → “来自智能直生”等。
  - 再配合 `guideCost` 等参数补充成本或身份信息。
- **验证**：分别以不同 Source 进入页面，确认文案与上下文一致。

## 后续建议
- 落实前端修复后，补充对应的单元测试或 Playwright 流程，覆盖导出按钮、分享按钮与轮询逻辑。
- 与后端同步直生模式的会话策略，避免生成孤立数据难以追踪。
- 完成调整后更新 `DEBUGGING_GUIDE.md` 或相关运营文档，使客服能够快速定位常见问题。

