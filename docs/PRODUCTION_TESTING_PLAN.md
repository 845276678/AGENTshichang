# 生产环境功能测试计划

## 测试目标
验证以下核心功能在生产环境的正常运行:
1. AI创意竞价系统
2. 商业计划书生成
3. 认证时序修复验证

## 测试环境
- **URL**: https://aijiayuan.top/
- **测试时间**: 2025-10-04
- **浏览器**: Chrome (推荐)

## 前置条件
- [ ] 已注册用户账号
- [ ] 已登录系统
- [ ] 账户有足够积分

---

## 测试用例 1: AI创意竞价流程

### 1.1 创建创意
**步骤**:
1. 登录系统
2. 进入创意市场 `/marketplace`
3. 点击"发布创意"
4. 填写创意信息:
   - 标题: "智能健康管理APP测试"
   - 描述: "基于AI的个性化健康管理解决方案,提供饮食、运动、睡眠跟踪和建议"
   - 分类: 选择合适的分类
5. 提交创意

**预期结果**:
- ✅ 创意提交成功
- ✅ 扣除相应积分
- ✅ 获得提交奖励积分
- ✅ 显示创意ID

### 1.2 启动AI竞价
**步骤**:
1. 在创意列表中找到刚创建的创意
2. 点击"开始AI竞价"按钮
3. WebSocket连接建立
4. 观察AI代理讨论过程

**预期结果**:
- ✅ WebSocket连接成功
- ✅ 显示实时竞价状态
- ✅ 5个AI代理依次发言
- ✅ 显示实时出价
- ✅ 观察者计数正确

**关键检查点**:
```javascript
// 在浏览器控制台查看WebSocket连接
// 应该看到类似消息:
{
  "type": "session.init",
  "payload": {
    "connectionId": "xxx",
    "ideaId": "xxx",
    "currentPhase": "warmup",
    "status": "connected"
  }
}
```

### 1.3 竞价阶段验证
**步骤**:
1. 等待AI代理完成warmup阶段
2. 观察discussion阶段
3. 观察bidding阶段
4. 等待竞价完成

**预期结果**:
- ✅ 阶段切换提示明确
- ✅ AI代理响应内容相关
- ✅ 出价逻辑合理(80-500积分)
- ✅ 显示最高出价者
- ✅ 平均出价计算正确

### 1.4 竞价结果
**步骤**:
1. 竞价结束后查看结果
2. 检查获胜者信息
3. 点击"生成商业计划"按钮

**预期结果**:
- ✅ 显示完整的竞价摘要
- ✅ 获胜者信息正确
- ✅ 最高出价显示
- ✅ 平均出价显示
- ✅ "生成商业计划"按钮可点击

---

## 测试用例 2: 商业计划书生成 (核心修复验证)

### 2.1 从竞价跳转到商业计划 (5分钟内免认证)
**步骤**:
1. 竞价完成后,立即点击"生成商业计划"
2. 观察页面跳转
3. 检查URL参数

**预期结果**:
- ✅ 页面正常跳转到 `/business-plan?sessionId=xxx&source=ai-bidding`
- ✅ **不出现401错误** (关键验证点!)
- ✅ 显示加载进度
- ✅ 显示生成阶段

**验证认证时序修复**:
打开浏览器开发者工具 (F12) → Network标签:
```
GET /api/business-plan-session?sessionId=xxx
Status: 200 OK (而非 401)
```

### 2.2 商业计划内容验证
**步骤**:
1. 等待商业计划生成完成
2. 检查各个部分的内容

**预期结果**:
- ✅ 显示创意标题
- ✅ 显示获胜AI代理信息
- ✅ 显示竞价金额
- ✅ 包含以下部分:
  - [ ] 当前形势与方向
  - [ ] 市场分析洞察
  - [ ] MVP调研指导
  - [ ] 90天执行计划
  - [ ] 商业模式设计

### 2.3 立即导出功能 (5分钟内免认证)
**步骤**:
1. 商业计划生成完成后
2. **立即**点击"下载"按钮
3. 选择Markdown格式

**预期结果**:
- ✅ **不出现401错误** (关键验证点!)
- ✅ 文件下载成功
- ✅ 文件名包含创意标题
- ✅ 内容完整

**验证导出时序修复**:
打开浏览器开发者工具 → Network标签:
```
GET /api/business-plan-report/[id]/export?format=markdown
Status: 200 OK (而非 401)
```

### 2.4 超时后访问 (5分钟后需认证)
**步骤**:
1. 等待6分钟
2. 刷新商业计划页面
3. 观察行为

**预期结果**:
- ✅ 要求登录认证
- ✅ 登录后正常显示内容
- ✅ 验证用户权限

---

## 测试用例 3: 其他关键功能

### 3.1 分享功能
**步骤**:
1. 在商业计划页面点击"分享"
2. 复制分享链接

**预期结果**:
- ✅ 链接格式正确
- ✅ 包含reportId参数
- ✅ 其他用户可访问(如有权限)

### 3.2 PDF导出
**步骤**:
1. 选择PDF格式导出
2. 下载文件

**预期结果**:
- ✅ PDF生成成功
- ✅ 格式正确
- ✅ 内容完整
- ✅ 中文显示正常

---

## 关键验证点总结

### 认证时序修复验证 ⭐⭐⭐
**最重要的测试点**:

1. **竞价→商业计划跳转** (5分钟内):
   ```
   预期: 200 OK
   实际: _____ (待测试)
   ```

2. **立即下载** (5分钟内):
   ```
   预期: 200 OK
   实际: _____ (待测试)
   ```

3. **超时后访问** (5分钟后):
   ```
   预期: 401 → 要求登录
   实际: _____ (待测试)
   ```

### WebSocket功能验证
- [ ] 连接建立正常
- [ ] 消息实时推送
- [ ] 阶段切换流畅
- [ ] 断线重连

### AI服务验证
- [ ] DeepSeek响应正常
- [ ] 智谱GLM响应正常
- [ ] 通义千问响应正常
- [ ] 内容质量符合预期

---

## 错误场景测试

### 场景1: 未登录用户访问旧报告
**步骤**:
1. 清除cookies登出
2. 访问一个超过5分钟的报告链接

**预期**:
- ✅ 返回401或重定向到登录

### 场景2: 用户访问他人报告
**步骤**:
1. 用户A生成报告
2. 用户B尝试访问

**预期**:
- ✅ 返回403 Forbidden (如超过5分钟)

### 场景3: WebSocket连接失败
**步骤**:
1. 禁用WebSocket
2. 尝试启动竞价

**预期**:
- ✅ 显示友好错误提示
- ✅ 提供重试选项

---

## 性能测试

### 响应时间
- [ ] API响应 < 100ms
- [ ] 页面加载 < 2s
- [ ] WebSocket延迟 < 50ms

### 并发测试
- [ ] 多个用户同时竞价
- [ ] 多个报告同时生成
- [ ] WebSocket连接数限制

---

## 浏览器兼容性
- [ ] Chrome (主要)
- [ ] Firefox
- [ ] Safari
- [ ] Edge

---

## 测试结果记录

### 测试执行人: _____________
### 测试日期: _____________

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 1.1 创建创意 | ⬜ | |
| 1.2 启动AI竞价 | ⬜ | |
| 1.3 竞价阶段验证 | ⬜ | |
| 1.4 竞价结果 | ⬜ | |
| 2.1 免认证跳转 ⭐ | ⬜ | |
| 2.2 商业计划内容 | ⬜ | |
| 2.3 免认证导出 ⭐ | ⬜ | |
| 2.4 超时后认证 | ⬜ | |
| 3.1 分享功能 | ⬜ | |
| 3.2 PDF导出 | ⬜ | |

**图例**:
- ✅ 通过
- ❌ 失败
- ⚠️ 部分通过
- ⬜ 未测试

---

## 发现的问题

### 问题1: [待填写]
- **严重程度**:
- **复现步骤**:
- **预期行为**:
- **实际行为**:
- **截图/日志**:

### 问题2: [待填写]
...

---

## 测试总结

**整体评估**: [待填写]

**主要成就**:
- [待填写]

**待改进项**:
- [待填写]

**下一步行动**:
- [待填写]

---

## 自动化测试脚本

### 健康检查脚本
```bash
#!/bin/bash
echo "=== 生产环境快速检查 ==="

# 1. API健康
echo "1. API Health:"
curl -s https://aijiayuan.top/api/health | jq -r '.status'

# 2. WebSocket状态
echo "2. WebSocket:"
curl -s https://aijiayuan.top/api/websocket-status | jq -r '.websocketServerRunning'

# 3. 核心页面
echo "3. 核心页面:"
for page in / /marketplace /business-plan; do
  code=$(curl -s -o /dev/null -w "%{http_code}" "https://aijiayuan.top$page")
  echo "  $page: $code"
done

echo "=== 检查完成 ==="
```

### API认证测试脚本
```javascript
// 在浏览器控制台运行
async function testAuthTiming() {
  const sessionId = 'YOUR_SESSION_ID'; // 替换为实际sessionId

  console.log('测试1: 5分钟内访问 (应该成功)');
  const res1 = await fetch(`/api/business-plan-session?sessionId=${sessionId}`);
  console.log('状态:', res1.status, res1.status === 200 ? '✅' : '❌');

  console.log('\n等待5分钟后再次测试...');
  setTimeout(async () => {
    console.log('测试2: 5分钟后访问 (应该要求认证)');
    const res2 = await fetch(`/api/business-plan-session?sessionId=${sessionId}`);
    console.log('状态:', res2.status, res2.status === 401 ? '✅' : '❌');
  }, 5 * 60 * 1000);
}

testAuthTiming();
```
