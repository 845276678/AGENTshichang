# 商业计划生成系统 - 架构调整方案（生产版）

## 目标与范围
- 采用 DeepSeek、智谱 GLM、阿里通义千问 三个 AI 服务，完成包含场景校验在内的 9 个生成阶段
- 构建统一的 AI 调用、成本管理、监控、缓存与重试框架，便于扩展与合规审计
- 确保用户提交创意后，AI 能进行具体场景深度分析与落地验证，再进入后续商业计划生成
- 保障前后端、数据库、缓存、CI/CD 发布的可观测性与回滚能力

## 现状诊断
| 领域 | 现状 | 主要风险 |
| ---- | ---- | -------- |
| AI 服务配置 | 代码里保留 5 个服务商占位，实际仅调用 3 个 | 配置漂移、调用失败不易定位 |
| 场景分析 | 创意提交后缺少具体场景校验，直接进入业务规划 | 输出脱离真实场景，落地性不足 |
| 成本控制 | 未接入 `cost-manager` | 无法预估预算，难以止损 |
| 阶段流程 | 阶段与服务能力匹配度低，缺乏依赖关系 | 生成质量不稳定、重试成本高 |
| 状态管理 | 前端使用本地 `useState`，缺乏暂停/恢复等控制函数 | 体验不完整，无法对接后端队列 |
| 监控报警 | 无统一指标采集 | 生产问题无法快速定位 |

## 目标架构概览
```
Client (Next.js)
  ├── Scenario Intake Form + Validation
  └── Zustand Store + 控制面板
Backend (Next.js API Routes)
  ├── BusinessPlanGenerator Service
  │   ├── ScenarioReasoner (DeepSeek/GLM/Qwen 编排)
  │   ├── AIServiceManager
  │   ├── CostManager (Prisma)
  │   └── BiddingMetrics (monitoring client)
  ├── Scenario Repository (PostgreSQL + Redis)
  └── Progress/Telemetry APIs
Infra
  ├── Redis (阶段缓存 / 幂等 / 任务队列)
  ├── Prometheus + Grafana (指标)
  ├── ClickHouse (长周期指标)
  └── Sentry (错误)
```

## 创意场景深度分析流程
### 1. 场景数据采集
- 用户提交时需补充：行业、目标用户画像、地域/监管限制、可用资源、上线渠道、预算区间
- 前端通过 `ScenarioForm` 校验必填项，写入 `ideaData.context` 字段
- 对于缺失信息，AI 通过澄清问题模板向用户追问，记录在 `scenario_clarifications`

### 2. AI 场景推理编排
- **步骤 A：语义归档**（DeepSeek）
  - 将创意提取为 `核心价值 / 使用场景 / 关键角色`
- **步骤 B：场景拆解**（智谱 GLM）
  - 按人、货、场或 B/S/C 链路拆分操作流程，识别关键技术/资源约束
- **步骤 C：市场对照**（通义千问）
  - 从行业数据仓库映射对标案例，输出竞争格局与成熟度
- **步骤 D：落地性评分**（多模型投票）
  - 指标：可用资源匹配度、技术可行性、法规敏感度、投入产出周期
  - 设定阈值 <70 分触发二次澄清或自动生成风险提示

AI 编排通过 `ScenarioReasoner` 服务实现，采用链式思维（CoT）+ 结构化输出，完整日志写入审计表。

### 3. 场景输出与验收
```json
{
  "ideaId": "uuid",
  "scenario": {
    "summary": "在三线城市打造...",
    "primaryUseCase": ["线下连锁门店", "B2B2C 渠道"],
    "actors": [
      { "name": "加盟商", "needs": ["快速复制"] },
      { "name": "城市运营经理", "needs": ["库存预测"] }
    ],
    "assumptions": ["6 个月内可获取试点门店 10 家"],
    "risks": [
      { "type": "法规", "detail": "需符合当地餐饮许可" },
      { "type": "资源", "detail": "缺少冷链合作伙伴" }
    ],
    "feasibilityScore": {
      "overall": 78,
      "resourceFit": 82,
      "techFit": 74,
      "compliance": 70,
      "marketReadiness": 85
    },
    "recommendedPilots": [
      { "city": "长沙", "channel": "商超快消" }
    ]
  },
  "nextSteps": [
    { "type": "clarify", "question": "请补充供应链合作伙伴情况" }
  ]
}
```
- `feasibilityScore.overall` < 70 时，系统阻塞后续阶段，并提示用户补充信息或选择降级模板版商业计划
- 通过 `scenario_validation.log` 记录 AI 推理链、使用模型、token 成本，满足审计与复现

### 4. 场景落地验证
- 将场景信息与企业内部运营指标对照（若有数据源，使用 Data Warehouse API 校验）
- 与行业黑名单/敏感领域库比对，若命中则附加合规提示
- 自动匹配 `Scenario Playbook` 模板，为后续阶段提供先验数据（例如标准门店 CAPEX 模板）

## 阶段设计（含场景校验）
| 阶段 ID | 名称 | AI 服务 | 预计耗时 | 产出 | 前置依赖 |
| ------- | ---- | ------- | -------- | ---- | -------- |
| scenario_grounding | 场景洞察与落地校验 | DeepSeek 主导 + GLM/Qwen 协同 | 6-8 分钟 | 场景摘要、角色链路、落地性评分、澄清问题列表 | ideaData |
| concept_analysis | 创意概念解析 | DeepSeek | 3-5 分钟 | 概念提取报告、核心价值分析、问题陈述 | scenario_grounding |
| market_research | 市场调研分析 | 通义千问 | 8-12 分钟 | 市场规模、竞品分析、目标用户画像 | scenario_grounding |
| tech_architecture | 技术架构设计 | 智谱 GLM | 10-15 分钟 | 系统架构、API 设计、技术栈推荐 | scenario_grounding |
| business_model | 商业模式构建 | DeepSeek | 6-10 分钟 | 商业模式画布、收入流、成本结构 | market_research |
| financial_model | 财务建模预测 | 通义千问 | 12-18 分钟 | 财务预测、投资回报、估值 | business_model |
| legal_compliance | 合规风险评估 | 智谱 GLM | 8-12 分钟 | 合规清单、法律风险、知识产权策略 | scenario_grounding |
| implementation_plan | 实施路线规划 | 智谱 GLM | 6-10 分钟 | 项目时间表、团队配置、里程碑 | tech_architecture |
| investor_pitch | 投资推介材料 | DeepSeek | 5-8 分钟 | Pitch Deck、投资亮点、融资策略 | 其余阶段 |

## 核心服务实现
### ScenarioReasoner
```ts
export class ScenarioReasoner {
  constructor(private readonly aiManager: AIServiceManager) {}

  async analyze(input: IdeaPayload): Promise<ScenarioOutput> {
    const traceId = createTraceId()
    const semantic = await this.aiManager.generateStructured(
      AIServiceProvider.DEEPSEEK,
      prompts.semanticArchive(input),
      { traceId }
    )

    const decomposition = await this.aiManager.generateStructured(
      AIServiceProvider.ZHIPU,
      prompts.decompose(semantic),
      { traceId }
    )

    const benchmarking = await this.aiManager.generateStructured(
      AIServiceProvider.ALI,
      prompts.marketCompare({ ...semantic, ...decomposition }),
      { traceId }
    )

    const feasibility = computeFeasibility({ semantic, decomposition, benchmarking })

    return { traceId, semantic, decomposition, benchmarking, feasibility }
  }
}
```
- `computeFeasibility` 根据权重聚合评分，同时生成需二次澄清的缺口项
- 所有步骤写入 `scenario_analysis_logs`，字段含 `trace_id`、`model`, `prompt_template`, `latency`, `cost`

### BusinessPlanGenerator 服务
```ts
export class BusinessPlanGenerator {
  constructor(private readonly deps: Dependencies = {}) {
    this.aiManager = deps.aiServiceManager ?? new AIServiceManager()
    this.costManager = deps.costManager ?? new CostManager(prisma)
    this.metrics = deps.metrics ?? new BiddingMetrics(monitoring)
    this.scenarioReasoner = deps.scenarioReasoner ?? new ScenarioReasoner(this.aiManager)
  }

  async generateAll(ideaData: IdeaPayload) {
    const scenario = await this.ensureScenarioGrounded(ideaData)
    for (const stage of this.resolveStages()) {
      await this.generateStage(stage, { ...ideaData, scenario })
    }
  }

  private async ensureScenarioGrounded(ideaData: IdeaPayload) {
    const cached = await redis.get(`bp:scenario:${ideaData.ideaId}`)
    if (cached) return JSON.parse(cached)

    const scenario = await this.scenarioReasoner.analyze(ideaData)
    if (scenario.feasibility.overall < 70) {
      throw new ScenarioInsufficientError({
        ideaId: ideaData.ideaId,
        recommendations: scenario.feasibility.actions,
        traceId: scenario.traceId
      })
    }

    await prisma.businessPlanScenario.upsert({
      where: { ideaId: ideaData.ideaId },
      update: { payload: scenario },
      create: { ideaId: ideaData.ideaId, payload: scenario }
    })
    await redis.setEx(`bp:scenario:${ideaData.ideaId}`, 86_400, JSON.stringify(scenario))
    return scenario
  }
}
```
- 若场景评分不足，抛出自定义错误供前端提示用户补充信息
- `resolveStages` 会自动将 `scenario_grounding` 排在首位，并将其结果注入后续阶段 prompt

### 前端状态管理（Zustand）
```ts
interface BusinessPlanState {
  scenario: ScenarioOutput | null
  scenarioStatus: 'idle' | 'analyzing' | 'needs_clarification' | 'ready'
  clarificationQuestions: ClarificationQuestion[]
  uploadScenarioContext: (context: ScenarioContext) => Promise<void>
  respondClarification: (questionId: string, answer: string) => Promise<void>
  // ...原有字段
}
```
- 在 `startGeneration` 前先调用 `uploadScenarioContext`
- 当后端返回 `ScenarioInsufficientError` 时，状态切换到 `needs_clarification`，展示澄清问题列表

### API 契约
| Endpoint | 方法 | 请求 | 响应 | 说明 |
| -------- | ---- | ---- | ---- | ---- |
| `/api/scenario/analyze` | POST | `{ ideaId, context: ScenarioContext, ideaSummary }` | `{ success: true, data: ScenarioOutput }` | 单独触发场景推理，供保存草稿 |
| `/api/scenario/clarify` | POST | `{ ideaId, answers: ClarificationAnswer[] }` | `{ success: true, data: ScenarioOutput }` | 回答澄清问题后重新评估 |
| `/api/generate-business-plan` | POST | `{ ideaId, ideaData, force? }` | `{ success: true, data: PlanResult }` | 若未传 `scenario`，内部自动调用 `ensureScenarioGrounded` |
| `/api/generate-business-plan/progress` | GET | `?ideaId=` | `{ success: true, data: StageProgress[] }` | 包含 `scenario_grounding` 阶段 |
| `/api/generate-business-plan/stop` | POST | `{ ideaId }` | `{ success: true }` | 停止流程 |
| `/api/generate-business-plan/retry` | POST | `{ ideaId, stageId }` | `{ success: true }` | 重新入队 |

### 数据与存储
- **PostgreSQL**
  - `business_plan_scenario (idea_id PK, payload JSONB, feasibility NUMERIC, trace_id TEXT, created_at)`
  - `business_plan_stage (idea_id, stage_id, status, payload, error, started_at, completed_at, cost)`
  - `business_plan_cost (...)`
- **Redis**
  - `bp:scenario:{ideaId}`：场景结果缓存，TTL 24h
  - `bp:clarification:{ideaId}`：待回答问题列表
  - `bp:queue` / `bp:progress:{ideaId}`：维持原有功能
- **对象存储**：保存完整的 `scenario_analysis_logs` 供审计

### 监控与报警
- 新增指标：`bp_scenario_latency_seconds`、`bp_scenario_score`、`bp_scenario_clarification_pending`
- 日志：`scenario_trace_id`、`feasibility_score`、`clarification_count`
- 报警阈值：
  - 10 分钟内 `scenario_grounding` 失败率 > 5% -> PagerDuty
  - 平均 `bp_scenario_score` < 75 -> Slack 提示检查数据质量

### 安全与合规
- 场景数据可能含敏感资源/合作方信息：采用字段级加密（KMS）存储
- 合规检测包含地域法规库，对需备案行业（医疗、教育等）自动添加合规任务
- 审计：保留 AI 推理链条、对话记录、用户澄清回答 90 天

## 测试计划
- 单元测试：ScenarioReasoner prompt 映射、feasibility 算法、clarification 流程
- 集成测试：`scenario_grounding` 阶段缓存命中、澄清→重跑链路、队列重试
- E2E：Playwright 场景提交流程（含澄清）、暂停/重试、SSE 进度
- 负载：k6 模拟 200 并发场景分析 + 200 商业计划生成，验证 Redis 和成本控制
- 验收：至少 5 个真实业务创意复盘，确认场景输出与业务认知一致

## 部署与回滚
1. **准备阶段（T-7）**：
   - 更新 `prisma migrate`（新增 scenario 表）
   - 配置 `SCENARIO_CLARIFICATION_LIMIT` 等环境变量
   - 为 Prometheus 新指标建图
2. **灰度阶段（T-2）**：
   - 选取 10% 创意流量启用场景分析
   - 重点观察 `bp_scenario_score`、clarification 次数、SLA
3. **全面发布（T）**：
   - 扩容 Scenario Worker 副本
   - 将旧版计划生成开关设为只读
4. **回滚策略**：
   - 保留 `scenario_grounding` feature flag，可即时关闭
   - 执行 `rollback_scenario.sql` 恢复数据库，清理 `bp:scenario:*`

## 里程碑
| Milestone | 内容 | 截止 |
| --------- | ---- | ---- |
| M1 | 完成 ScenarioReasoner 与日志审计 | +1 周 |
| M2 | 前端场景表单、澄清交互上线 | +2 周 |
| M3 | 与现有阶段联调、成本/监控看板 | +3 周 |
| M4 | 灰度发布与复盘 | +4 周 |
| M5 | 全量上线、文档归档 | +5 周 |

## 风险与缓解
| 风险 | 影响 | 缓解措施 |
| ---- | ---- | -------- |
| 用户信息缺失 | 场景评分偏低 | 澄清问题模板 + 必填校验 + 降级提示 |
| AI 结论偏差 | 错误判断落地性 | 引入对标数据、人工抽检、保留回溯日志 |
| 成本/时延上升 | 用户等待超时 | 缓存命中率监控、场景结果复用、批量澄清 |
| 敏感信息泄露 | 合规风险 | 字段加密、访问审计、数据分级 |

## 总结
通过将“场景洞察与落地校验”作为商业计划生成的首要阶段，并配合澄清机制、落地评分和监控指标，系统可以对用户创意进行深入的场景推理，确保生成内容贴近真实业务环境。依托统一的 AI 服务编排、成本控制、监控与回滚方案，该架构可安全稳定地在生产环境运行。
\n\n## 实施进度（2025-09-26）\n- 新增 \\ScenarioReasoner\\ 与 Redis 缓存实现场景落地分析（\\src/lib/business-plan/scenario-reasoner.ts\\）。\n- \\/api/generate-business-plan\\ 已切换为先执行场景校验，返回 9 阶段执行计划（\\src/app/api/generate-business-plan/route.ts\\）。\n- 新增生产版前端入口 \\/business-plan/v2\\ 支持场景信息录入、落地评分展示与阶段排期（\\src/app/business-plan/v2/page.tsx\\）。\n- 场景分析数据类型统一定义于 \\src/types/business-plan.ts\\，阶段配置集中在 \\src/lib/business-plan/stages.ts\\，便于扩展与测试。\n
- 生成状态持久化至 Redis（src/lib/business-plan/storage.ts），支持 GET /api/generate-business-plan?ideaId=xxx 获取实时进度。
