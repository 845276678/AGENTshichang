generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
  binaryTargets   = ["native", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x", "rhel-openssl-3.0.x"]
  engineType      = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                @id @default(cuid())
  email                String                @unique
  username             String                @unique
  passwordHash         String                @map("password_hash")
  firstName            String?               @map("first_name")
  lastName             String?               @map("last_name")
  phone                String?               @unique
  avatar               String?
  bio                  String?
  status               UserStatus            @default(ACTIVE)
  role                 UserRole              @default(USER)
  isEmailVerified      Boolean               @default(false) @map("is_email_verified")
  isPhoneVerified      Boolean               @default(false) @map("is_phone_verified")
  credits              Int                   @default(2000)
  level                UserLevel             @default(BRONZE)
  totalSpent           Int                   @default(0) @map("total_spent")
  totalEarned          Int                   @default(0) @map("total_earned")
  totalGuesses         Int                   @default(0) @map("total_guesses")
  guessAccuracy        Float                 @default(0) @map("guess_accuracy")
  guessEarnings        Int                   @default(0) @map("guess_earnings")
  guessLevel           Int                   @default(1) @map("guess_level")
  levelProgress        Float                 @default(0) @map("level_progress")
  consecutiveGuesses   Int                   @default(0) @map("consecutive_guesses")
  bestStreak           Int                   @default(0) @map("best_streak")
  favoriteAgent        String?               @map("favorite_agent")
  emailNotifications   Boolean               @default(true) @map("email_notifications")
  marketingEmails      Boolean               @default(false) @map("marketing_emails")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  lastLoginAt          DateTime?             @map("last_login_at")
  biddingSessions      BiddingSession[]
  businessPlanReports  BusinessPlanReport[]
  businessPlanSessions BusinessPlanSession[]
  cartItems            CartItem[]
  creditTransactions   CreditTransaction[]
  files                File[]
  discussions          IdeaDiscussion[]
  ideas                Idea[]
  orders               Order[]
  payments             Payment[]
  priceGuesses         PriceGuess[]
  refreshTokens        RefreshToken[]
  researchReports      ResearchReport[]
  achievements         UserAchievement[]
  biddingBehaviors     UserBiddingBehavior[]
  sessions             UserSession[]
  dailyIdeaFeedbacks   DailyIdeaFeedback[]
  dailyIdeaFeedbackVotes DailyIdeaFeedbackVote[]
  dailyIdeaEngagements DailyIdeaEngagement[]
  dailyIdeaDebates     IdeaDebate[]              // 新增：创意辩论记录
  pointTransactions    PointTransaction[]        // 新增：积分交易记录
  userPoints           UserPoints?
  userPointTransactions UserPointTransaction[]
  ideaGrowthTrees      IdeaGrowthTree[]
  pressureTestResults  PressureTestResult[]

  @@map("users")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  isRevoked Boolean  @default(false) @map("is_revoked")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Idea {
  id              String           @id @default(cuid())
  title           String
  description     String
  category        IdeaCategory
  tags            String           @default("")
  userId          String           @map("user_id")
  isAnonymous     Boolean          @default(false) @map("is_anonymous")
  status          IdeaStatus       @default(PENDING)
  visibility      IdeaVisibility   @default(PUBLIC)
  viewCount       Int              @default(0) @map("view_count")
  likeCount       Int              @default(0) @map("like_count")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  biddingSessions BiddingSession[]
  discussions     IdeaDiscussion[]
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  researchReports ResearchReport[]

  @@map("ideas")
}

model BiddingSession {
  id                   String                @id @default(cuid())
  ideaId               String                @map("idea_id")
  userId               String?               @map("user_id")
  startPrice           Int                   @default(50) @map("start_price")
  currentHigh          Int                   @default(50) @map("current_high")
  winnerAgent          String?               @map("winner_agent")
  winnerAgentType      String?               @map("winner_agent_type")
  finalPrice           Int?                  @map("final_price")
  status               BiddingStatus         @default(PENDING)
  phase                BiddingPhase          @default(DISCUSSION)
  enhancedByDiscussion Boolean               @default(false) @map("enhanced_by_discussion")
  discussionId         String?               @map("discussion_id")
  enhancementScore     Float                 @default(0.0) @map("enhancement_score")
  participantCount     Int                   @default(0) @map("participant_count")
  viewerCount          Int                   @default(0) @map("viewer_count")
  maxViewerCount       Int                   @default(0) @map("max_viewer_count")
  totalInteractions    Int                   @default(0) @map("total_interactions")
  durationSeconds      Int                   @default(900) @map("duration_seconds")
  discussionDuration   Int                   @default(600) @map("discussion_duration")
  biddingDuration      Int                   @default(900) @map("bidding_duration")
  startedAt            DateTime?             @map("started_at")
  endedAt              DateTime?             @map("ended_at")
  discussionStartedAt  DateTime?             @map("discussion_started_at")
  biddingStartedAt     DateTime?             @map("bidding_started_at")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  avgResponseTime      Float                 @default(0) @map("avg_response_time")
  aiServiceCost        Float                 @default(0) @map("ai_service_cost")
  userEngagementScore  Float                 @default(0) @map("user_engagement_score")
  contentQualityScore  Float                 @default(0) @map("content_quality_score")
  interactions         AIInteraction[]
  discussion           IdeaDiscussion?       @relation("IdeaDiscussionBidding", fields: [discussionId], references: [id])
  idea                 Idea                  @relation(fields: [ideaId], references: [id])
  user                 User?                 @relation(fields: [userId], references: [id])
  bids                 Bid[]
  priceGuesses         PriceGuess[]
  behaviors            UserBiddingBehavior[]

  @@index([status, createdAt])
  @@index([ideaId, status])
  @@index([userId, status])
  @@map("bidding_sessions")
}

model Bid {
  id                 String         @id @default(cuid())
  sessionId          String         @map("session_id")
  agentName          String         @map("agent_name")
  agentType          String         @map("agent_type")
  amount             Int
  comment            String?
  confidence         Float?
  analysisData       Json?          @map("analysis_data")
  reasoning          String?
  emotionalState     String         @default("neutral") @map("emotional_state")
  isScripted         Boolean        @default(true) @map("is_scripted")
  aiServiceUsed      String?        @map("ai_service_used")
  generationCost     Float          @default(0) @map("generation_cost")
  responseTimeMs     Int            @default(0) @map("response_time_ms")
  qualityScore       Float          @default(0) @map("quality_score")
  understandingDepth Float          @default(0.5) @map("understanding_depth")
  contextRichness    Float          @default(0.5) @map("context_richness")
  createdAt          DateTime       @default(now()) @map("created_at")
  session            BiddingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([agentName, createdAt])
  @@map("bids")
}

model PriceGuess {
  id                        String         @id @default(cuid())
  sessionId                 String         @map("session_id")
  userId                    String         @map("user_id")
  guessedPrice              Int            @map("guessed_price")
  confidence                Float
  stakeAmount               Int            @default(10) @map("stake_amount")
  actualPrice               Int?           @map("actual_price")
  accuracy                  Float?
  reward                    Int?
  basedOnDiscussion         Boolean        @default(false) @map("based_on_discussion")
  predictionConfidenceBonus Float          @default(0.0) @map("prediction_confidence_bonus")
  timeSpentMs               Int?           @map("time_spent_ms")
  adjustmentCount           Int            @default(0) @map("adjustment_count")
  createdAt                 DateTime       @default(now()) @map("created_at")
  session                   BiddingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user                      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([userId, createdAt])
  @@map("price_guesses")
}

model AIInteraction {
  id              String            @id @default(cuid())
  sessionId       String            @map("session_id")
  agentName       String            @map("agent_name")
  agentType       String            @map("agent_type")
  interactionType AIInteractionType @map("interaction_type")
  phase           String
  content         String
  emotion         String            @default("neutral")
  animation       String            @default("none")
  isScripted      Boolean           @default(true) @map("is_scripted")
  aiServiceUsed   String?           @map("ai_service_used")
  generationCost  Float             @default(0) @map("generation_cost")
  responseTimeMs  Int               @default(0) @map("response_time_ms")
  qualityScore    Float             @default(0) @map("quality_score")
  userReactions   Json              @default("{}") @map("user_reactions")
  engagementScore Float             @default(0) @map("engagement_score")
  isRandomEvent   Boolean           @default(false) @map("is_random_event")
  eventType       String?           @map("event_type")
  createdAt       DateTime          @default(now()) @map("created_at")
  session         BiddingSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([agentName, createdAt])
  @@map("ai_interactions")
}

model UserBiddingBehavior {
  id         String            @id @default(cuid())
  sessionId  String            @map("session_id")
  userId     String            @map("user_id")
  actionType UserBiddingAction @map("action_type")
  actionData Json?             @map("action_data")
  timestamp  DateTime          @default(now())
  phase      String?
  agentName  String?           @map("agent_name")
  session    BiddingSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@index([userId, timestamp])
  @@map("user_bidding_behaviors")
}

model AIServiceUsage {
  id               String   @id @default(cuid())
  sessionId        String?  @map("session_id")
  agentName        String?  @map("agent_name")
  serviceName      String   @map("service_name")
  modelName        String?  @map("model_name")
  promptTokens     Int      @map("prompt_tokens")
  completionTokens Int      @map("completion_tokens")
  totalTokens      Int      @map("total_tokens")
  requestCount     Int      @default(1) @map("request_count")
  totalCost        Float    @map("total_cost")
  responseTimeMs   Int      @map("response_time_ms")
  qualityRating    Float?   @map("quality_rating")
  userSatisfaction Float?   @map("user_satisfaction")
  errorCount       Int      @default(0) @map("error_count")
  retryCount       Int      @default(0) @map("retry_count")
  createdAt        DateTime @default(now()) @map("created_at")
  date             DateTime @default(now())

  @@index([serviceName, date])
  @@index([sessionId, createdAt])
  @@map("ai_service_usage")
}

model UserAchievement {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  achievementId   String   @map("achievement_id")
  achievementName String   @map("achievement_name")
  description     String
  category        String
  bonusPoints     Int      @map("bonus_points")
  earnedAt        DateTime @default(now()) @map("earned_at")
  progressData    Json?    @map("progress_data")
  isRare          Boolean  @default(false) @map("is_rare")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, earnedAt])
  @@map("user_achievements")
}

model ResearchReport {
  id              String       @id @default(cuid())
  ideaId          String       @map("idea_id")
  userId          String       @map("user_id")
  reportData      Json         @map("report_data")
  summary         String?
  basicAnalysis   Json?        @map("basic_analysis")
  researchMethods Json?        @map("research_methods")
  dataSources     Json?        @map("data_sources")
  mvpGuidance     Json?        @map("mvp_guidance")
  businessModel   Json?        @map("business_model")
  status          ReportStatus @default(GENERATING)
  progress        Int          @default(0)
  creditsCost     Int          @map("credits_cost")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  completedAt     DateTime?    @map("completed_at")
  idea            Idea         @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("research_reports")
}

model CreditTransaction {
  id            String                @id @default(cuid())
  userId        String                @map("user_id")
  amount        Int
  type          CreditTransactionType
  description   String?
  relatedId     String?               @map("related_id")
  balanceBefore Int                   @map("balance_before")
  balanceAfter  Int                   @map("balance_after")
  createdAt     DateTime              @default(now()) @map("created_at")
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("credit_transactions")
}

model Payment {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  outTradeNo      String    @unique @map("out_trade_no")
  amount          Float
  credits         Int
  description     String
  currency        String    @default("CNY")
  provider        String
  providerOrderId String?   @map("provider_order_id")
  payUrl          String?   @map("pay_url")
  qrCodeUrl       String?   @map("qr_code_url")
  status          String    @default("PENDING")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  paidAt          DateTime? @map("paid_at")
  expiredAt       DateTime  @map("expired_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  refunds         Refund[]

  @@map("payments")
}

model Refund {
  id               String    @id @default(cuid())
  paymentId        String    @map("payment_id")
  outRefundNo      String    @unique @map("out_refund_no")
  refundAmount     Float     @map("refund_amount")
  reason           String
  status           String    @default("PROCESSING")
  providerRefundId String?   @map("provider_refund_id")
  operatorId       String    @map("operator_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  refundedAt       DateTime? @map("refunded_at")
  payment          Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("refunds")
}

model File {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  filename     String
  originalName String    @map("original_name")
  key          String    @unique
  url          String
  size         Int
  contentType  String    @map("content_type")
  type         String    @default("OTHER")
  status       String    @default("UPLOADED")
  metadata     Json?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("files")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

model AIUsageStats {
  id           String   @id @default(cuid())
  provider     String
  model        String
  requestCount Int      @default(0) @map("request_count")
  totalTokens  Int      @default(0) @map("total_tokens")
  totalCost    Float    @default(0) @map("total_cost")
  date         DateTime
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([provider, model, date])
  @@map("ai_usage_stats")
}

model IdeaDiscussion {
  id              String              @id @default(cuid())
  ideaId          String              @map("idea_id")
  userId          String              @map("user_id")
  status          DiscussionStatus    @default(ACTIVE)
  currentRound    Int                 @default(1) @map("current_round")
  totalRounds     Int                 @default(3) @map("total_rounds")
  aiAgentType     String              @map("ai_agent_type")
  aiAgentName     String              @map("ai_agent_name")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  completedAt     DateTime?           @map("completed_at")
  biddingSessions BiddingSession[]    @relation("IdeaDiscussionBidding")
  messages        DiscussionMessage[]
  idea            Idea                @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("idea_discussions")
}

model DiscussionMessage {
  id           String         @id @default(cuid())
  discussionId String         @map("discussion_id")
  content      String
  messageType  MessageType    @map("message_type")
  roundNumber  Int            @map("round_number")
  senderType   SenderType     @map("sender_type")
  senderName   String?        @map("sender_name")
  analysisData Json?          @map("analysis_data")
  suggestions  Json?
  createdAt    DateTime       @default(now()) @map("created_at")
  discussion   IdeaDiscussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  @@map("discussion_messages")
}

model Order {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  amount        Float
  currency      String      @default("CNY")
  description   String
  status        OrderStatus @default(PENDING)
  paymentMethod String?     @map("payment_method")
  paymentId     String?     @map("payment_id")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  paidAt        DateTime?   @map("paid_at")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("orders")
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  agentId   String   @map("agent_id")
  price     Float?
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("cart_items")
}

model Agent {
  id          String      @id @default(cuid())
  name        String
  description String
  type        AgentType
  status      AgentStatus @default(ACTIVE)
  price       Float?
  credits     Int?
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@map("agents")
}

model BusinessPlanSession {
  id           String                    @id @default(cuid())
  userId       String?                   @map("user_id")
  ideaId       String?                   @map("idea_id")
  source       BusinessPlanSource        @default(AI_BIDDING)
  status       BusinessPlanSessionStatus @default(PENDING)
  snapshot     Json
  expiresAt    DateTime?                 @map("expires_at")
  createdAt    DateTime                  @default(now()) @map("created_at")
  updatedAt    DateTime                  @updatedAt @map("updated_at")
  access_token String?                   @unique
  audits       BusinessPlanAudit[]
  reports      BusinessPlanReport[]
  user         User?                     @relation(fields: [userId], references: [id])

  @@map("business_plan_sessions")
}

model BusinessPlanReport {
  id        String              @id @default(cuid())
  sessionId String              @map("session_id")
  userId    String?             @map("user_id")
  guide     Json
  version   Int                 @default(1)
  metadata  Json?
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")
  session   BusinessPlanSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User?               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("business_plan_reports")
}

model BusinessPlanAudit {
  id        String              @id @default(cuid())
  sessionId String              @map("session_id")
  action    String
  payload   Json?
  createdBy String?             @map("created_by")
  createdAt DateTime            @default(now()) @map("created_at")
  session   BusinessPlanSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("business_plan_audits")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum UserLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum IdeaCategory {
  TECH
  LIFESTYLE
  EDUCATION
  HEALTH
  FINANCE
  ENTERTAINMENT
  BUSINESS
  RETAIL
  OTHER
}

enum IdeaStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

enum IdeaVisibility {
  PUBLIC
  PRIVATE
  UNLISTED
}

enum BiddingStatus {
  PENDING
  ACTIVE
  ENDED
  CANCELLED
  FAILED
}

enum BiddingPhase {
  DISCUSSION
  BIDDING
  RESULTS
}

enum AIInteractionType {
  opening
  bid_reaction
  psychology
  result
  glitch
  mimicry
  conflict
  alliance
  breakdown
  user_response
}

enum UserBiddingAction {
  enter_session
  leave_session
  support_agent
  react_to_dialogue
  submit_guess
  adjust_guess
  share_session
  report_issue
}

enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
  CANCELLED
}

enum CreditTransactionType {
  REGISTER_BONUS
  PURCHASE
  RESEARCH_COST
  REFUND
  ADMIN_ADJUSTMENT
  WITHDRAW
  BUSINESS_PLAN_COST
}

enum DiscussionStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
}

enum MessageType {
  INITIAL_ANALYSIS
  CLARIFICATION_REQUEST
  USER_RESPONSE
  IMPROVEMENT_SUGGESTION
  FINAL_ASSESSMENT
}

enum SenderType {
  USER
  AI_AGENT
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum AgentType {
  CREATIVE
  ANALYTICAL
  TECHNICAL
  BUSINESS
  MARKETING
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum BusinessPlanSessionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum BusinessPlanSource {
  AI_BIDDING
  MARKETPLACE
  API
  MANUAL
}

// ============================================
// 创意成熟度评估系统 (Creative Maturity Grading)
// Added: 2025-01-09
// Spec: CREATIVE_MATURITY_PLAN_ENHANCED.md v4.1
// ============================================

// 创意成熟度评估结果表
model CreativeMaturityAdvice {
  id                String   @id @default(cuid())
  ideaId            String   @map("idea_id")
  userId            String?  @map("user_id")

  // 评分结果
  maturityScore     Float    @map("maturity_score")      // 1-10
  maturityLevel     String   @map("maturity_level")      // LOW/GRAY_LOW/MEDIUM/GRAY_HIGH/HIGH
  dimensions        Json     @map("dimensions")          // 5维详情
  confidence        Float    @map("confidence")          // 0-1

  // 专家建议
  expertAdvice      Json     @map("expert_advice")       // 按等级分类的建议
  weakDimensions    String[] @map("weak_dimensions")     // 薄弱维度列表

  // 专家共识
  expertConsensus   Json     @map("expert_consensus")    // 专家观点统计

  // The Mom Test信号
  validSignals      Json     @map("valid_signals")       // 有效信号统计
  invalidSignals    Json     @map("invalid_signals")     // 无效信号统计

  // 评分原因
  scoringReasons    Json     @map("scoring_reasons")     // 评分原因块

  // 验证数据(高分创意)
  verificationData  Json?    @map("verification_data")   // 用户填写的验证问卷
  verificationLinks Json?    @map("verification_links")  // 网上检索的参考链接
  verifiedAt        DateTime? @map("verified_at")

  // 元数据
  scoringVersion    String   @map("scoring_version")     // "1.0.0"

  // 时间戳
  createdAt         DateTime @default(now()) @map("created_at")
  expiresAt         DateTime @map("expires_at")          // 默认7天后过期
  extendedUntil     DateTime? @map("extended_until")     // 用户延长至

  @@index([ideaId, createdAt])
  @@index([expiresAt]) // 用于定时清理
  @@map("creative_maturity_advice")
}

// 评分权重配置表
model ScoringWeightConfig {
  id                String   @id @default(cuid())
  version           String   @unique                      // "1.0.0"
  isActive          Boolean  @default(false)             // 是否当前激活
  isCanary          Boolean  @default(false)             // 是否灰度版本
  canaryPercentage  Int      @default(0)                 // 灰度百分比(0-100)

  // 5维权重(总和=1.0)
  targetCustomer    Float    @map("target_customer")      // 0.20
  demandScenario    Float    @map("demand_scenario")      // 0.20
  coreValue         Float    @map("core_value")           // 0.25
  businessModel     Float    @map("business_model")       // 0.20
  credibility       Float    @map("credibility")          // 0.15

  // 阈值配置
  thresholdLowMax   Float    @default(4.0)               // 低分上限
  thresholdMidMin   Float    @default(5.0)               // 中分下限
  thresholdMidMax   Float    @default(7.0)               // 中分上限
  thresholdHighMin  Float    @default(7.5)               // 高分下限

  description       String?                              // 配置说明
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // 标定数据
  calibrationSetSize Int?    @map("calibration_set_size") // 标定集样本数
  calibrationAccuracy Float? @map("calibration_accuracy") // 标定准确率

  @@map("scoring_weight_config")
}

// 验证订单表(用于计费保护)
model VerificationOrder {
  id                String   @id @default(cuid())
  ideaId            String   @map("idea_id")
  userId            String   @map("user_id")
  amount            Int                                  // 积分数量
  status            String                               // PENDING/COMPLETED/FAILED
  error             String?                              // 失败原因
  createdAt         DateTime @default(now()) @map("created_at")
  completedAt       DateTime? @map("completed_at")
  failedAt          DateTime? @map("failed_at")

  @@index([ideaId])
  @@index([userId])
  @@map("verification_order")
}

// 问卷草稿表(支持分段提交)
model QuestionnaireDraft {
  id                String   @id @default(cuid())
  ideaId            String   @map("idea_id")
  userId            String   @map("user_id")
  answers           Json                                 // 已填写的答案
  progress          Float                                // 完成进度(0-1)
  savedAt           DateTime @default(now()) @map("saved_at")
  expiresAt         DateTime @map("expires_at")          // 默认7天后过期

  @@index([ideaId, userId])
  @@index([expiresAt])
  @@map("questionnaire_draft")
}

// ============================================
// 创意成熟度评估系统 v2.0 (10分制)
// Added: 2025-01-15
// Spec: IDEA_MATURITY_SYSTEM.md v2.0
// ============================================

// 成熟度评估结果表 (10分制)
model MaturityAssessment {
  id                String   @id @default(cuid())
  ideaId            String   @map("idea_id")
  userId            String   @map("user_id")
  sessionId         String   @map("session_id")

  // 评分结果 (10分制)
  totalScore        Float    @map("total_score")         // 1.0-10.0
  level             String   @map("level")               // LOW/GRAY_LOW/MEDIUM/GRAY_HIGH/HIGH
  confidence        Float    @map("confidence")          // 0.5-1.0

  // 5个维度详情
  dimensions        Json     @map("dimensions")          // DimensionScores

  // The Mom Test信号统计
  validSignals      Json     @map("valid_signals")       // ValidSignals
  invalidSignals    Json     @map("invalid_signals")     // InvalidSignals

  // 专家共识
  expertConsensus   Json     @map("expert_consensus")    // ExpertConsensus

  // 评分原因块
  scoringReasons    Json     @map("scoring_reasons")     // ScoringReason[]

  // 薄弱维度列表
  weakDimensions    String[] @map("weak_dimensions")     // 用于工作坊推荐

  // 工作坊解锁状态
  workshopUnlocked  Boolean  @map("workshop_unlocked")   // totalScore >= 5.0

  // 元数据
  scoringVersion    String   @map("scoring_version")     // "1.0.0"

  // 时间戳
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([ideaId, createdAt])
  @@index([userId, createdAt])
  @@index([sessionId])
  @@index([totalScore])
  @@index([level])
  @@map("maturity_assessments")
}

// ============================================
// 工作坊系统 (Workshop System)
// Added: 2025-01-15
// Spec: week4_workshop_interactive_plan.md
// ============================================

// 工作坊会话表
model WorkshopSession {
  id                String   @id @default(cuid())
  workshopId        String   @map("workshop_id")        // 工作坊类型: demand-validation, mvp-builder, growth-hacking, profit-model
  userId            String   @map("user_id")
  assessmentId      String?  @map("assessment_id")      // 关联的成熟度评估ID

  // 进度追踪
  currentStep       Int      @default(1)                // 当前步骤
  totalSteps        Int      @map("total_steps")        // 总步骤数
  completedSteps    Int[]    @map("completed_steps")    // 已完成步骤列表
  progressPercentage Float   @default(0)                // 完成百分比

  // 表单数据
  formData          Json     @default("{}") @map("form_data")  // 用户填写的表单内容

  // Agent对话历史
  conversationHistory Json   @default("[]") @map("conversation_history")  // AgentMessage[]

  // 状态
  status            WorkshopStatus @default(IN_PROGRESS)
  startedAt         DateTime @default(now()) @map("started_at")
  completedAt       DateTime? @map("completed_at")
  lastActivityAt    DateTime @updatedAt @map("last_activity_at")

  // 成果输出
  pdfReportUrl      String?  @map("pdf_report_url")    // PDF报告下载链接
  pdfGeneratedAt    DateTime? @map("pdf_generated_at")

  // 元数据
  metadata          Json?    @default("{}")            // 额外元数据（如时长、评分等）

  // 时间戳
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([workshopId])
  @@index([assessmentId])
  @@index([status, createdAt])
  @@map("workshop_sessions")
}

// 工作坊状态枚举
enum WorkshopStatus {
  IN_PROGRESS      // 进行中
  COMPLETED        // 已完成
  ABANDONED        // 已放弃
}

// ============================================
// Agent使用统计系统
// Added: 2025-01-15
// ============================================

// Agent使用日志表（原始记录）
model AgentUsageLog {
  id          String   @id @default(cuid())
  userId      String?  @map("user_id")          // 用户ID（可选，未登录用户为null）
  agentId     String   @map("agent_id")         // Agent标识 (tech-pioneer-alex/alex/maturity-assessor等)
  module      String   @map("module")           // 所在模块 (bidding/workshop/assessment)
  action      String   @map("action")           // 具体动作 (bid/chat/evaluate/view等)
  sessionId   String?  @map("session_id")       // 关联的会话ID
  metadata    Json?    @map("metadata")         // 额外信息
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([agentId, module, createdAt])
  @@index([userId, agentId])
  @@index([createdAt])
  @@map("agent_usage_logs")
}

// Agent使用统计表（聚合数据，每日18:00更新）
model AgentUsageStats {
  id              String   @id @default(cuid())
  agentId         String   @map("agent_id")
  module          String   @map("module")
  date            DateTime @map("date")          // 统计日期（YYYY-MM-DD 00:00:00）
  totalUses       Int      @default(0) @map("total_uses")        // 总使用次数
  uniqueUsers     Int      @default(0) @map("unique_users")      // 唯一用户数
  lastUpdatedAt   DateTime @updatedAt @map("last_updated_at")    // 最后更新时间
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([agentId, module, date])
  @@index([agentId, module])
  @@index([date])
  @@map("agent_usage_stats")
}

// ============================================
// Agent预算管理系统
// Added: 2025-01-15
// Purpose: 将竞价Agent的每日预算从内存迁移到数据库
// ============================================

// Agent预算表（用于竞价系统中的Agent出价预算管理）
model AgentBudget {
  id              String   @id @default(cuid())
  agentId         String   @map("agent_id")           // Agent标识 (tech-pioneer-alex等)
  date            DateTime @map("date")                // 预算日期 (YYYY-MM-DD 00:00:00)
  dailyLimit      Int      @default(2000) @map("daily_limit")        // 每日预算限额
  remainingBudget Int      @map("remaining_budget")    // 剩余预算
  totalSpent      Int      @default(0) @map("total_spent")           // 已花费金额
  bidCount        Int      @default(0) @map("bid_count")             // 出价次数
  lastBidAt       DateTime? @map("last_bid_at")        // 最后一次出价时间
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([agentId, date])
  @@index([agentId, date])
  @@index([date])
  @@map("agent_budgets")
}

// ============================================
// 每日一创意系统 (Daily Idea System)
// Added: 2025-01-15
// Purpose: 实现每日创意推送、用户反馈和积分奖励机制
// ============================================

// 每日创意表
model DailyIdea {
  id                 String           @id @default(cuid())
  title              String           @map("title")                   // 创意标题
  description        String           @map("description")             // 创意描述
  maturity           Int              @map("maturity")                // 成熟度 0-100
  domain             String[]         @map("domain")                  // 领域标签
  guidingQuestions   String[]         @map("guiding_questions")       // 引导问题
  implementationHints String[]        @map("implementation_hints")    // 实施提示
  publishDate        DateTime         @map("publish_date")            // 发布日期 (YYYY-MM-DD 08:00:00)
  isActive           Boolean          @default(true) @map("is_active") // 是否激活
  viewCount          Int              @default(0) @map("view_count")   // 查看次数
  feedbackCount      Int              @default(0) @map("feedback_count") // 反馈次数
  averageRating      Float?           @map("average_rating")          // 平均评分
  metadata           Json?            @map("metadata")                // 额外元数据
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  // 关联关系
  feedbacks          DailyIdeaFeedback[]
  userEngagements    DailyIdeaEngagement[]
  debates            IdeaDebate[]                // 新增：智能辩论记录

  @@unique([publishDate])
  @@index([publishDate, isActive])
  @@index([isActive, createdAt])
  @@map("daily_ideas")
}

// 用户反馈表
model DailyIdeaFeedback {
  id            String                @id @default(cuid())
  dailyIdeaId   String               @map("daily_idea_id")
  userId        String               @map("user_id")
  type          DailyIdeaFeedbackType @map("type")             // 反馈类型
  content       String               @map("content")           // 反馈内容
  qualityScore  Float                @map("quality_score")     // AI评估质量分 0-100
  helpfulness   Float                @default(0) @map("helpfulness") // 社区投票有用性 0-100
  pointsAwarded Int                  @map("points_awarded")    // 获得积分
  isVerified    Boolean              @default(false) @map("is_verified") // 是否经过人工验证
  metadata      Json?                @map("metadata")          // 额外元数据
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")

  // 关联关系
  dailyIdea     DailyIdea            @relation(fields: [dailyIdeaId], references: [id], onDelete: Cascade)
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes         DailyIdeaFeedbackVote[]

  @@unique([dailyIdeaId, userId])
  @@index([userId, createdAt])
  @@index([dailyIdeaId, qualityScore])
  @@map("daily_idea_feedbacks")
}

// 反馈投票表
model DailyIdeaFeedbackVote {
  id         String            @id @default(cuid())
  feedbackId String            @map("feedback_id")
  userId     String            @map("user_id")
  voteType   FeedbackVoteType  @map("vote_type")        // HELPFUL/NOT_HELPFUL
  createdAt  DateTime          @default(now()) @map("created_at")

  // 关联关系
  feedback   DailyIdeaFeedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([feedbackId, userId])
  @@index([feedbackId])
  @@map("daily_idea_feedback_votes")
}

// 用户参与记录表
model DailyIdeaEngagement {
  id          String    @id @default(cuid())
  dailyIdeaId String    @map("daily_idea_id")
  userId      String    @map("user_id")
  hasViewed   Boolean   @default(false) @map("has_viewed")     // 是否查看过
  hasFeedback Boolean   @default(false) @map("has_feedback")   // 是否提交反馈
  hasShared   Boolean   @default(false) @map("has_shared")     // 是否分享过
  viewDuration Int?     @map("view_duration")                  // 查看时长(秒)
  engagementScore Float @default(0) @map("engagement_score")   // 参与度评分
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // 关联关系
  dailyIdea   DailyIdea @relation(fields: [dailyIdeaId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dailyIdeaId, userId])
  @@index([userId, createdAt])
  @@map("daily_idea_engagements")
}

// 用户积分表
model UserPoints {
  id           String   @id @default(cuid())
  userId       String   @unique @map("user_id")
  totalPoints  Int      @default(0) @map("total_points")       // 总积分
  dailyPoints  Int      @default(0) @map("daily_points")       // 今日获得积分
  weeklyPoints Int      @default(0) @map("weekly_points")      // 本周获得积分
  lastResetAt  DateTime @default(now()) @map("last_reset_at")  // 上次重置时间
  streakDays   Int      @default(0) @map("streak_days")        // 连续参与天数
  bestStreak   Int      @default(0) @map("best_streak")        // 最佳连续记录
  level        Int      @default(1) @map("level")              // 用户等级
  experience   Int      @default(0) @map("experience")         // 经验值
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联关系
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions UserPointTransaction[]

  @@index([totalPoints])
  @@index([level])
  @@map("user_points")
}

// 积分交易记录表
model UserPointTransaction {
  id          String                  @id @default(cuid())
  userId      String                  @map("user_id")
  pointsId    String                  @map("points_id")
  type        PointTransactionType    @map("type")                 // 交易类型
  amount      Int                     @map("amount")               // 积分数量
  reason      String?                 @map("reason")               // 交易原因
  relatedId   String?                 @map("related_id")           // 关联ID（如反馈ID）
  balance     Int                     @map("balance")              // 交易后余额
  metadata    Json?                   @map("metadata")             // 额外元数据
  createdAt   DateTime                @default(now()) @map("created_at")

  // 关联关系
  user        User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userPoints  UserPoints              @relation(fields: [pointsId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@map("user_point_transactions")
}

// 创意生长树数据表
model IdeaGrowthTree {
  id              String              @id @default(cuid())
  userId          String              @map("user_id")
  rootIdeaId      String              @map("root_idea_id")        // 根创意ID
  title           String              @map("title")                // 生长树标题
  description     String?             @map("description")          // 描述
  treeData        Json                @map("tree_data")            // 树状结构数据
  totalNodes      Int                 @default(1) @map("total_nodes") // 总节点数
  maxDepth        Int                 @default(1) @map("max_depth")   // 最大深度
  isPublic        Boolean             @default(false) @map("is_public") // 是否公开
  viewCount       Int                 @default(0) @map("view_count")   // 查看次数
  metadata        Json?               @map("metadata")             // 额外元数据
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // 关联关系
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  modifications   IdeaModification[]

  @@index([userId, createdAt])
  @@index([rootIdeaId])
  @@map("idea_growth_trees")
}

// 创意修改记录表
model IdeaModification {
  id          String         @id @default(cuid())
  treeId      String         @map("tree_id")
  nodeId      String         @map("node_id")              // 节点ID
  parentId    String?        @map("parent_id")            // 父节点ID
  content     String         @map("content")              // 修改内容
  reason      String?        @map("reason")               // 修改原因
  impact      ModificationImpact @map("impact")          // 影响程度
  tags        String[]       @map("tags")                 // 标签
  maturity    Int            @map("maturity")             // 成熟度 0-100
  metadata    Json?          @map("metadata")             // 额外元数据
  createdAt   DateTime       @default(now()) @map("created_at")

  // 关联关系
  tree        IdeaGrowthTree @relation(fields: [treeId], references: [id], onDelete: Cascade)

  @@index([treeId, createdAt])
  @@index([nodeId])
  @@map("idea_modifications")
}

// 压力测试场景表
model PressureTestScenario {
  id                 String                @id @default(cuid())
  title              String                @map("title")                    // 场景标题
  description        String                @map("description")              // 场景描述
  type               PressureScenarioType  @map("type")                     // 场景类型
  severity           Int                   @map("severity")                 // 严重程度 1-3
  domain             String[]              @map("domain")                   // 适用领域
  questions          String[]              @map("questions")                // 测试问题
  isPersonalized     Boolean               @default(false) @map("is_personalized") // 是否个性化
  usageCount         Int                   @default(0) @map("usage_count")  // 使用次数
  averageScore       Float?                @map("average_score")            // 平均得分
  metadata           Json?                 @map("metadata")                 // 额外元数据
  isActive           Boolean               @default(true) @map("is_active")  // 是否激活
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")

  // 关联关系
  testResults        PressureTestResult[]

  @@index([type, isActive])
  @@index([domain])
  @@map("pressure_test_scenarios")
}

// 压力测试结果表
model PressureTestResult {
  id                String               @id @default(cuid())
  scenarioId        String               @map("scenario_id")
  userId            String               @map("user_id")
  ideaId            String?              @map("idea_id")                  // 关联的创意ID
  answers           Json                 @map("answers")                  // 用户答案
  overallScore      Float                @map("overall_score")            // 总体得分
  dimensionScores   Json                 @map("dimension_scores")         // 各维度得分
  recommendations   String[]             @map("recommendations")          // 改进建议
  contingencyPlans  String[]             @map("contingency_plans")        // 应急计划
  completionTime    Int                  @map("completion_time")          // 完成时长(秒)
  metadata          Json?                @map("metadata")                 // 额外元数据
  createdAt         DateTime             @default(now()) @map("created_at")

  // 关联关系
  scenario          PressureTestScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([scenarioId])
  @@index([ideaId])
  @@map("pressure_test_results")
}

// 枚举定义
enum DailyIdeaFeedbackType {
  IMPROVEMENT      // 改进建议
  IMPLEMENTATION   // 实施方案
  MARKET_INSIGHT   // 市场洞察
  RISK_ANALYSIS    // 风险分析
}

enum FeedbackVoteType {
  HELPFUL          // 有用
  NOT_HELPFUL      // 无用
}

enum PointTransactionType {
  DAILY_PARTICIPATION    // 每日参与
  QUALITY_FEEDBACK      // 质量反馈
  HELPFUL_VOTE          // 被点赞
  WEEKLY_STREAK         // 连续参与奖励
  PREMIUM_FEATURE       // 积分消费
  SYSTEM_ADJUSTMENT     // 系统调整
}

enum ModificationImpact {
  MINOR             // 轻微调整
  MAJOR             // 重大修改
  PIVOT             // 方向转变
}

enum PressureScenarioType {
  FUNDING           // 资金压力
  COMPETITION       // 竞争压力
  MARKET            // 市场压力
  TECHNICAL         // 技术压力
  REGULATORY        // 监管压力
  OPERATIONAL       // 运营压力
}

// ============================================
// 智能辩论系统 (AI Debate System)
// Added: 2025-10-15
// Purpose: 实现用户与AI的创意辩论功能，帮助用户完善创意想法
// ============================================

// 创意辩论记录表
model IdeaDebate {
  id                String              @id @default(cuid())
  dailyIdeaId       String              @map("daily_idea_id")
  userId            String              @map("user_id")
  userComment       String              @map("user_comment")             // 用户评论
  commentType       DebateCommentType   @map("comment_type")             // 评论类型
  commentQuality    Float               @map("comment_quality")          // 评论质量分 1-10
  aiResponse        String              @map("ai_response")              // AI回应内容
  aiResponseType    DebateResponseType  @map("ai_response_type")         // AI回应类型
  aiPersona         String              @map("ai_persona")               // AI角色
  aiReasoning       String?             @map("ai_reasoning")             // AI推理过程
  followUpQuestions String[]            @map("follow_up_questions")      // 后续引导问题
  improvements      String[]            @map("improvements")             // 改进建议
  pointsAwarded     Int                 @default(0) @map("points_awarded") // 获得积分
  metadata          Json?               @map("metadata")                 // 额外元数据
  createdAt         DateTime            @default(now()) @map("created_at")

  // 关联关系
  dailyIdea         DailyIdea           @relation(fields: [dailyIdeaId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([dailyIdeaId, createdAt])
  @@index([userId, createdAt])
  @@index([commentQuality])
  @@map("idea_debates")
}

// 积分交易记录表 (通用)
model PointTransaction {
  id            String               @id @default(cuid())
  userId        String               @map("user_id")
  type          PointTransactionType @map("type")                    // 交易类型
  amount        Int                  @map("amount")                  // 积分数量 (可为负)
  reason        String?              @map("reason")                  // 交易原因
  relatedId     String?              @map("related_id")              // 关联ID
  balanceBefore Int                  @map("balance_before")          // 交易前余额
  balanceAfter  Int                  @map("balance_after")           // 交易后余额
  metadata      Json?                @map("metadata")                // 额外元数据
  createdAt     DateTime             @default(now()) @map("created_at")

  // 关联关系
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@map("point_transactions")
}

// 辩论相关枚举
enum DebateCommentType {
  CRITIQUE          // 批评质疑
  SUGGESTION        // 改进建议
  QUESTION          // 疑问询问
  PRAISE            // 赞扬认同
  GENERAL           // 一般评论
}

enum DebateResponseType {
  AGREE             // 赞同扩展
  DISAGREE          // 礼貌反驳
  GUIDE             // 引导思考
  EXPAND            // 深化扩展
}

