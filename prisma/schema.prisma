// AIåˆ›æ„è°ƒç ”å¹³å°æ•°æ®åº“æ¨¡ï¿?- ç”Ÿäº§çº§å¢å¼ºç‰ˆ
// æ”¯æŒç”¨æˆ·ç®¡ç†ã€åˆ›æ„æäº¤ã€è°ƒç ”æŒ‡å¯¼ã€ç«ä»·ç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿç­‰æ ¸å¿ƒåŠŸèƒ½

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x", "rhel-openssl-3.0.x"]
  engineType    = "library"
  previewFeatures = []
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ç”¨æˆ·ï¿?
model User {
  id           String  @id @default(cuid())
  email        String  @unique
  username     String  @unique
  passwordHash String  @map("password_hash")
  firstName    String? @map("first_name")
  lastName     String? @map("last_name")
  phone        String? @unique
  avatar       String?
  bio          String?

  // ç”¨æˆ·çŠ¶ï¿½?
  status          UserStatus @default(ACTIVE)
  role            UserRole   @default(USER)
  isEmailVerified Boolean    @default(false) @map("is_email_verified")
  isPhoneVerified Boolean    @default(false) @map("is_phone_verified")

  // ç§¯åˆ†å’Œç­‰ï¿?
  credits     Int       @default(1000) // æ³¨å†Œèµ ï¿½?000ç§¯åˆ†
  level       UserLevel @default(BRONZE)
  totalSpent  Int       @default(0) @map("total_spent")
  totalEarned Int       @default(0) @map("total_earned")

  // ç«ä»·ç›¸å…³ç»Ÿè®¡ - æ–°å¢
  totalGuesses       Int     @default(0) @map("total_guesses")
  guessAccuracy      Float   @default(0) @map("guess_accuracy")
  guessEarnings      Int     @default(0) @map("guess_earnings")
  guessLevel         Int     @default(1) @map("guess_level")
  levelProgress      Float   @default(0) @map("level_progress")
  consecutiveGuesses Int     @default(0) @map("consecutive_guesses")
  bestStreak         Int     @default(0) @map("best_streak")
  favoriteAgent      String? @map("favorite_agent")

  // é€šçŸ¥è®¾ç½®
  emailNotifications Boolean @default(true) @map("email_notifications")
  marketingEmails    Boolean @default(false) @map("marketing_emails")

  // æ—¶é—´ï¿?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // å…³è”å…³ç³»
  ideas              Idea[]
  researchReports    ResearchReport[]
  creditTransactions CreditTransaction[]
  payments           Payment[]
  sessions           UserSession[]
  refreshTokens      RefreshToken[]
  files              File[]
  discussions        IdeaDiscussion[]
  orders             Order[]
  cartItems          CartItem[]
  biddingSessions    BiddingSession[] // æ–°å¢
  priceGuesses       PriceGuess[] // æ–°å¢
  biddingBehaviors   UserBiddingBehavior[] // æ–°å¢
  achievements       UserAchievement[] // æ–°å¢
  businessPlanSessions BusinessPlanSession[] // ÉÌÒµ¼Æ»®»á»°
  businessPlanReports  BusinessPlanReport[] // ÉÌÒµ¼Æ»®±¨¸æ

  @@map("users")
}

// ç”¨æˆ·çŠ¶æ€æšï¿?
enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

// ç”¨æˆ·è§’è‰²æšä¸¾
enum UserRole {
  USER
  ADMIN
  MODERATOR
}

// ç”¨æˆ·ç­‰çº§æšä¸¾
enum UserLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

// ç”¨æˆ·ä¼šè¯ï¿?
model UserSession {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

// åˆ·æ–°ä»¤ç‰Œï¿?
model RefreshToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  isRevoked Boolean  @default(false) @map("is_revoked")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// åˆ›æ„ï¿?
model Idea {
  id          String       @id @default(cuid())
  title       String
  description String
  category    IdeaCategory
  tags        String       @default("") // æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”

  // æäº¤è€…ä¿¡ï¿?
  userId      String  @map("user_id")
  isAnonymous Boolean @default(false) @map("is_anonymous")

  // çŠ¶æ€ç®¡ï¿?
  status     IdeaStatus     @default(PENDING)
  visibility IdeaVisibility @default(PUBLIC)

  // ç»Ÿè®¡æ•°æ®
  viewCount Int @default(0) @map("view_count")
  likeCount Int @default(0) @map("like_count")

  // æ—¶é—´ï¿?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // å…³è”å…³ç³»
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  researchReports ResearchReport[]
  discussions     IdeaDiscussion[]
  biddingSessions BiddingSession[] // æ–°å¢

  @@map("ideas")
}

// åˆ›æ„åˆ†ç±»æšä¸¾
enum IdeaCategory {
  TECH
  LIFESTYLE
  EDUCATION
  HEALTH
  FINANCE
  ENTERTAINMENT
  BUSINESS
  RETAIL
  OTHER
}

// åˆ›æ„çŠ¶æ€æšï¿?
enum IdeaStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

// åˆ›æ„å¯è§æ€§æšï¿?
enum IdeaVisibility {
  PUBLIC
  PRIVATE
  UNLISTED
}

// ==================== ç«ä»·ç³»ç»Ÿæ ¸å¿ƒï¿?====================

// ç«ä»·ä¼šè¯ï¿?- ç”Ÿäº§çº§å¢å¼ºç‰ˆ
model BiddingSession {
  id              String  @id @default(cuid())
  ideaId          String  @map("idea_id")
  userId          String? @map("user_id") // ä¼šè¯å‘èµ·ï¿?
  startPrice      Int     @default(50) @map("start_price")
  currentHigh     Int     @default(50) @map("current_high")
  winnerAgent     String? @map("winner_agent")
  winnerAgentType String? @map("winner_agent_type")
  finalPrice      Int?    @map("final_price")

  // ä¼šè¯çŠ¶æ€å’Œé˜¶æ®µ
  status BiddingStatus @default(PENDING)
  phase  BiddingPhase  @default(DISCUSSION)

  // è®¨è®ºå¢å¼ºç›¸å…³
  enhancedByDiscussion Boolean @default(false) @map("enhanced_by_discussion")
  discussionId         String? @map("discussion_id")
  enhancementScore     Float   @default(0.0) @map("enhancement_score")

  // å‚ä¸ç»Ÿè®¡
  participantCount  Int @default(0) @map("participant_count")
  viewerCount       Int @default(0) @map("viewer_count")
  maxViewerCount    Int @default(0) @map("max_viewer_count")
  totalInteractions Int @default(0) @map("total_interactions")

  // æ—¶é—´æ§åˆ¶
  durationSeconds    Int @default(900) @map("duration_seconds") // 15åˆ†é’Ÿ
  discussionDuration Int @default(600) @map("discussion_duration") // 10åˆ†é’Ÿ
  biddingDuration    Int @default(900) @map("bidding_duration") // 15åˆ†é’Ÿ

  // æ—¶é—´ï¿?
  startedAt           DateTime? @map("started_at")
  endedAt             DateTime? @map("ended_at")
  discussionStartedAt DateTime? @map("discussion_started_at")
  biddingStartedAt    DateTime? @map("bidding_started_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // æ€§èƒ½å’Œè´¨é‡æŒ‡ï¿?
  avgResponseTime     Float @default(0) @map("avg_response_time")
  aiServiceCost       Float @default(0) @map("ai_service_cost")
  userEngagementScore Float @default(0) @map("user_engagement_score")
  contentQualityScore Float @default(0) @map("content_quality_score")

  // å…³è”å…³ç³»
  idea         Idea                  @relation(fields: [ideaId], references: [id])
  user         User?                 @relation(fields: [userId], references: [id])
  discussion   IdeaDiscussion?       @relation("IdeaDiscussionBidding", fields: [discussionId], references: [id])
  bids         Bid[]
  priceGuesses PriceGuess[]
  interactions AIInteraction[]
  behaviors    UserBiddingBehavior[]

  @@index([status, createdAt])
  @@index([ideaId, status])
  @@index([userId, status])
  @@map("bidding_sessions")
}

// ç«ä»·çŠ¶æ€æšï¿?
enum BiddingStatus {
  PENDING // ç­‰å¾…å¼€ï¿?
  ACTIVE // è¿›è¡Œï¿?
  ENDED // å·²ç»“ï¿?
  CANCELLED // å·²å–ï¿?
  FAILED // å¤±è´¥
}

// ç«ä»·é˜¶æ®µæšä¸¾
enum BiddingPhase {
  DISCUSSION // è®¨è®ºé˜¶æ®µ
  BIDDING // ç«ä»·é˜¶æ®µ
  RESULTS // ç»“æœé˜¶æ®µ
}

// AIå‡ºä»·è®°å½•ï¿?- ç”Ÿäº§çº§å¢å¼ºç‰ˆ
model Bid {
  id         String  @id @default(cuid())
  sessionId  String  @map("session_id")
  agentName  String  @map("agent_name")
  agentType  String  @map("agent_type")
  amount     Int
  comment    String?
  confidence Float?

  // AIå†³ç­–æ•°æ®
  analysisData   Json?   @map("analysis_data")
  reasoning      String? // å‡ºä»·ç†ç”±
  emotionalState String  @default("neutral") @map("emotional_state")

  // ç”Ÿæˆç›¸å…³
  isScripted     Boolean @default(true) @map("is_scripted")
  aiServiceUsed  String? @map("ai_service_used")
  generationCost Float   @default(0) @map("generation_cost")
  responseTimeMs Int     @default(0) @map("response_time_ms")
  qualityScore   Float   @default(0) @map("quality_score")

  // ç†è§£æ·±åº¦ï¼ˆè®¨è®ºå¢å¼ºç›¸å…³ï¼‰
  understandingDepth Float @default(0.5) @map("understanding_depth")
  contextRichness    Float @default(0.5) @map("context_richness")

  createdAt DateTime @default(now()) @map("created_at")

  session BiddingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([agentName, createdAt])
  @@map("bids")
}

// ç”¨æˆ·ä»·æ ¼ç«çŒœï¿?- ç”Ÿäº§çº§å¢å¼ºç‰ˆ
model PriceGuess {
  id           String @id @default(cuid())
  sessionId    String @map("session_id")
  userId       String @map("user_id")
  guessedPrice Int    @map("guessed_price")
  confidence   Float
  stakeAmount  Int    @default(10) @map("stake_amount")

  // ç»“æœå’Œå¥–ï¿?
  actualPrice Int?   @map("actual_price")
  accuracy    Float? // å‡†ç¡®åº¦ç™¾åˆ†æ¯”
  reward      Int? // è·å¾—çš„å¥–åŠ±ç§¯ï¿?

  // å¢å¼ºä¿¡æ¯
  basedOnDiscussion         Boolean @default(false) @map("based_on_discussion")
  predictionConfidenceBonus Float   @default(0.0) @map("prediction_confidence_bonus")

  // ç”¨æˆ·è¡Œä¸ºæ•°æ®
  timeSpentMs     Int? @map("time_spent_ms")
  adjustmentCount Int  @default(0) @map("adjustment_count")

  createdAt DateTime @default(now()) @map("created_at")

  session BiddingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([userId, createdAt])
  @@map("price_guesses")
}

// AIäº¤æµè®°å½•ï¿?- ç”Ÿäº§çº§å¢å¼ºç‰ˆ
model AIInteraction {
  id        String @id @default(cuid())
  sessionId String @map("session_id")
  agentName String @map("agent_name")
  agentType String @map("agent_type")

  // äº¤äº’åˆ†ç±»
  interactionType AIInteractionType @map("interaction_type")
  phase           String // æ‰€å±é˜¶ï¿?

  // å†…å®¹å’Œè¡¨ï¿?
  content   String
  emotion   String @default("neutral")
  animation String @default("none")

  // ç”Ÿæˆå’Œè´¨é‡æ§ï¿?
  isScripted     Boolean @default(true) @map("is_scripted")
  aiServiceUsed  String? @map("ai_service_used")
  generationCost Float   @default(0) @map("generation_cost")
  responseTimeMs Int     @default(0) @map("response_time_ms")
  qualityScore   Float   @default(0) @map("quality_score")

  // ç”¨æˆ·ååº”ç»Ÿè®¡
  userReactions   Json  @default("{}") @map("user_reactions")
  engagementScore Float @default(0) @map("engagement_score")

  // ç‰¹æ®Šäº‹ä»¶
  isRandomEvent Boolean @default(false) @map("is_random_event")
  eventType     String? @map("event_type")

  createdAt DateTime @default(now()) @map("created_at")

  session BiddingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([agentName, createdAt])
  @@map("ai_interactions")
}

// AIäº¤äº’ç±»å‹æšä¸¾
enum AIInteractionType {
  opening // å¼€åœºåˆ†ï¿?
  bid_reaction // å‡ºä»·ååº”
  psychology // å¿ƒç†ï¿?
  result // ç»“æœç‚¹è¯„
  glitch // æ•…éšœäº‹ä»¶
  mimicry // æ¨¡ä»¿æ¸¸æˆ
  conflict // å†²çªå¯¹è¯
  alliance // è”ç›Ÿå½¢æˆ
  breakdown // äººè®¾å´©å
  user_response // ç”¨æˆ·äº’åŠ¨å›åº”
}

// ç”¨æˆ·ç«ä»·è¡Œä¸ºè¿½è¸ªï¿?- æ–°å¢
model UserBiddingBehavior {
  id         String            @id @default(cuid())
  sessionId  String            @map("session_id")
  userId     String            @map("user_id")
  actionType UserBiddingAction @map("action_type")
  actionData Json?             @map("action_data")
  timestamp  DateTime          @default(now())

  // è¡Œä¸ºä¸Šä¸‹ï¿?
  phase     String? // å‘ç”Ÿåœ¨å“ªä¸ªé˜¶ï¿?
  agentName String? @map("agent_name") // ç›¸å…³çš„AI

  session BiddingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@index([userId, timestamp])
  @@map("user_bidding_behaviors")
}

// ç”¨æˆ·ç«ä»·è¡Œä¸ºæšä¸¾
enum UserBiddingAction {
  enter_session // è¿›å…¥ä¼šè¯
  leave_session // ç¦»å¼€ä¼šè¯
  support_agent // æ”¯æŒæŸä¸ªAI
  react_to_dialogue // å¯¹å¯¹è¯åšå‡ºåï¿?
  submit_guess // æäº¤ä»·æ ¼é¢„æµ‹
  adjust_guess // è°ƒæ•´é¢„æµ‹
  share_session // åˆ†äº«ä¼šè¯
  report_issue // æŠ¥å‘Šé—®é¢˜
}

// AIæœåŠ¡ä½¿ç”¨ç»Ÿè®¡ï¿?- æ–°å¢
model AIServiceUsage {
  id          String  @id @default(cuid())
  sessionId   String? @map("session_id")
  agentName   String? @map("agent_name")
  serviceName String  @map("service_name") // deepseek, zhipu, etc.
  modelName   String? @map("model_name")

  // ä½¿ç”¨é‡ç»Ÿï¿?
  promptTokens     Int @map("prompt_tokens")
  completionTokens Int @map("completion_tokens")
  totalTokens      Int @map("total_tokens")
  requestCount     Int @default(1) @map("request_count")

  // æˆæœ¬å’Œæ€§èƒ½
  totalCost      Float @map("total_cost")
  responseTimeMs Int   @map("response_time_ms")

  // è´¨é‡è¯„ä¼°
  qualityRating    Float? @map("quality_rating")
  userSatisfaction Float? @map("user_satisfaction")

  // é”™è¯¯å’Œé‡ï¿?
  errorCount Int @default(0) @map("error_count")
  retryCount Int @default(0) @map("retry_count")

  createdAt DateTime @default(now()) @map("created_at")
  date      DateTime @default(now()) // æŒ‰å¤©ç»Ÿè®¡

  @@index([serviceName, date])
  @@index([sessionId, createdAt])
  @@map("ai_service_usage")
}

// ç”¨æˆ·æˆå°±ï¿?- æ–°å¢
model UserAchievement {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  achievementId   String   @map("achievement_id")
  achievementName String   @map("achievement_name")
  description     String
  category        String
  bonusPoints     Int      @map("bonus_points")
  earnedAt        DateTime @default(now()) @map("earned_at")

  // æˆå°±æ•°æ®
  progressData Json?   @map("progress_data")
  isRare       Boolean @default(false) @map("is_rare")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, earnedAt])
  @@map("user_achievements")
}

// ==================== åŸæœ‰ä¸šåŠ¡è¡¨ç»§ç»­ä¿ï¿?====================

// è°ƒç ”æŠ¥å‘Šï¿?
model ResearchReport {
  id     String @id @default(cuid())
  ideaId String @map("idea_id")
  userId String @map("user_id")

  // æŠ¥å‘Šå†…å®¹
  reportData Json    @map("report_data") // å­˜å‚¨å®Œæ•´çš„è°ƒç ”æŒ‡å¯¼ç»“ï¿?
  summary    String? // æŠ¥å‘Šæ‘˜è¦

  // AIä¸“å®¶åˆ†æç»“æœ
  basicAnalysis   Json? @map("basic_analysis") // åŸºæœ¬ç›˜åˆ†æç»“ï¿?
  researchMethods Json? @map("research_methods") // è°ƒç ”æ–¹æ³•æŒ‡å¯¼
  dataSources     Json? @map("data_sources") // æ•°æ®æºæ¨ï¿?
  mvpGuidance     Json? @map("mvp_guidance") // MVPéªŒè¯æŒ‡å¯¼
  businessModel   Json? @map("business_model") // å•†ä¸šæ¨¡å¼æŒ‡å¯¼

  // ç”ŸæˆçŠ¶ï¿½?
  status   ReportStatus @default(GENERATING)
  progress Int          @default(0) // ç”Ÿæˆè¿›åº¦ 0-100

  // æˆæœ¬ä¿¡æ¯
  creditsCost Int @map("credits_cost") // æ¶ˆè€—çš„ç§¯åˆ†

  // æ—¶é—´ï¿?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")

  // å…³è”å…³ç³»
  idea Idea @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("research_reports")
}

// æŠ¥å‘ŠçŠ¶æ€æšï¿?
enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
  CANCELLED
}

// ç§¯åˆ†äº¤æ˜“ï¿?
model CreditTransaction {
  id     String                @id @default(cuid())
  userId String                @map("user_id")
  amount Int // æ­£æ•°ä¸ºæ”¶å…¥ï¼Œè´Ÿæ•°ä¸ºæ”¯ï¿?
  type   CreditTransactionType

  // äº¤æ˜“è¯¦æƒ…
  description String?
  relatedId   String? @map("related_id") // å…³è”çš„ä¸šåŠ¡IDï¼ˆå¦‚æŠ¥å‘ŠIDã€æ”¯ä»˜IDç­‰ï¼‰

  // ä½™é¢å¿«ç…§
  balanceBefore Int @map("balance_before")
  balanceAfter  Int @map("balance_after")

  // æ—¶é—´ï¿?
  createdAt DateTime @default(now()) @map("created_at")

  // å…³è”å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("credit_transactions")
}

// ç§¯åˆ†äº¤æ˜“ç±»å‹æšä¸¾
enum CreditTransactionType {
    REGISTER_BONUS
    BUSINESS_PLAN_COST // æ³¨å†Œå¥–åŠ±
  PURCHASE // è´­ä¹°ç§¯åˆ†
  RESEARCH_COST // è°ƒç ”æŒ‡å¯¼æ¶ˆè´¹
  REFUND // é€€ï¿?
  ADMIN_ADJUSTMENT // ç®¡ç†å‘˜è°ƒï¿?
  WITHDRAW // æç°
}

// æ”¯ä»˜ï¿?
model Payment {
  id     String @id @default(cuid())
  userId String @map("user_id")

  // æ”¯ä»˜ä¿¡æ¯
  outTradeNo  String @unique @map("out_trade_no") // å•†æˆ·è®¢å•ï¿?
  amount      Float // æ”¯ä»˜é‡‘é¢ï¼ˆå…ƒï¿?
  credits     Int // å¯¹åº”ç§¯åˆ†æ•°é‡
  description String // æ”¯ä»˜æè¿°
  currency    String @default("CNY")

  // æ”¯ä»˜æ¸ é“
  provider        String // æ”¯ä»˜æä¾›å•†ï¼ˆALIPAY/WECHATï¿?
  providerOrderId String? @map("provider_order_id") // ç¬¬ä¸‰æ–¹è®¢å•å·

  // æ”¯ä»˜URLå’ŒäºŒç»´ç 
  payUrl    String? @map("pay_url")
  qrCodeUrl String? @map("qr_code_url")

  // æ”¯ä»˜çŠ¶ï¿½?
  status String @default("PENDING") // PENDING/SUCCESS/FAILED/CANCELLED/REFUNDED

  // æ—¶é—´ï¿?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  paidAt    DateTime? @map("paid_at")
  expiredAt DateTime  @map("expired_at") // æ”¯ä»˜è¿‡æœŸæ—¶é—´

  // å…³è”å…³ç³»
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refunds Refund[]

  @@map("payments")
}

// é€€æ¬¾è¡¨
model Refund {
  id        String @id @default(cuid())
  paymentId String @map("payment_id")

  // é€€æ¬¾ä¿¡ï¿?
  outRefundNo  String @unique @map("out_refund_no") // å•†æˆ·é€€æ¬¾å•ï¿?
  refundAmount Float  @map("refund_amount") // é€€æ¬¾é‡‘ï¿?
  reason       String // é€€æ¬¾åŸï¿?

  // é€€æ¬¾çŠ¶ï¿?
  status           String  @default("PROCESSING") // PROCESSING/SUCCESS/FAILED
  providerRefundId String? @map("provider_refund_id") // ç¬¬ä¸‰æ–¹é€€æ¬¾å•ï¿?

  // æ“ä½œä¿¡æ¯
  operatorId String @map("operator_id") // æ“ä½œå‘˜ID

  // æ—¶é—´ï¿?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  refundedAt DateTime? @map("refunded_at")

  // å…³è”å…³ç³»
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("refunds")
}

// æ–‡ä»¶ï¿?
model File {
  id     String @id @default(cuid())
  userId String @map("user_id")

  // æ–‡ä»¶ä¿¡æ¯
  filename     String // å­˜å‚¨çš„æ–‡ä»¶å
  originalName String @map("original_name") // åŸå§‹æ–‡ä»¶ï¿?
  key          String @unique // OSSå­˜å‚¨key
  url          String // è®¿é—®URL
  size         Int // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  contentType  String @map("content_type") // MIMEç±»å‹

  // æ–‡ä»¶åˆ†ç±»
  type   String @default("OTHER") // IMAGE/DOCUMENT/AVATAR/REPORT/OTHER
  status String @default("UPLOADED") // UPLOADING/UPLOADED/FAILED/DELETED

  // å…ƒæ•°ï¿?
  metadata Json? // å­˜å‚¨é¢å¤–ä¿¡æ¯ï¼ˆå¦‚å›¾ç‰‡å°ºå¯¸ã€å¤„ç†å‚æ•°ç­‰ï¿?

  // æ—¶é—´ï¿?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // å…³è”å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("files")
}

// ç³»ç»Ÿé…ç½®ï¿?
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

// AIæœåŠ¡ä½¿ç”¨ç»Ÿè®¡ï¿?
model AIUsageStats {
  id           String   @id @default(cuid())
  provider     String // AIæœåŠ¡æä¾›å•†ï¼ˆç™¾åº¦ã€é˜¿é‡Œã€è®¯é£ç­‰ï¿?
  model        String // æ¨¡å‹åç§°
  requestCount Int      @default(0) @map("request_count")
  totalTokens  Int      @default(0) @map("total_tokens")
  totalCost    Float    @default(0) @map("total_cost")
  date         DateTime

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([provider, model, date])
  @@map("ai_usage_stats")
}

// åˆ›æ„è®¨è®ºä¼šè¯ï¿?
model IdeaDiscussion {
  id     String @id @default(cuid())
  ideaId String @map("idea_id")
  userId String @map("user_id")

  // è®¨è®ºçŠ¶ï¿½?
  status       DiscussionStatus @default(ACTIVE)
  currentRound Int              @default(1) @map("current_round") // å½“å‰è½®æ•° 1-3
  totalRounds  Int              @default(3) @map("total_rounds") // æ€»è½®æ•°é™ï¿?

  // AI Agentä¿¡æ¯
  aiAgentType String @map("ai_agent_type") // åˆ†é…çš„AIä¸“å®¶ç±»å‹
  aiAgentName String @map("ai_agent_name") // AIä¸“å®¶åç§°

  // æ—¶é—´ï¿?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")

  // å…³è”å…³ç³»
  idea            Idea                @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages        DiscussionMessage[]
  biddingSessions BiddingSession[]    @relation("IdeaDiscussionBidding")

  @@map("idea_discussions")
}

// è®¨è®ºçŠ¶æ€æšï¿?
enum DiscussionStatus {
  ACTIVE // è¿›è¡Œï¿?
  COMPLETED // å·²å®Œï¿?
  EXPIRED // å·²è¿‡ï¿?
  CANCELLED // å·²å–ï¿?
}

// è®¨è®ºæ¶ˆæ¯ï¿?
model DiscussionMessage {
  id           String @id @default(cuid())
  discussionId String @map("discussion_id")

  // æ¶ˆæ¯å†…å®¹
  content     String // æ¶ˆæ¯å†…å®¹
  messageType MessageType @map("message_type") // æ¶ˆæ¯ç±»å‹
  roundNumber Int         @map("round_number") // æ‰€å±è½®ï¿?

  // å‘é€è€…ä¿¡ï¿?
  senderType SenderType @map("sender_type") // å‘é€è€…ç±»ï¿?
  senderName String?    @map("sender_name") // å‘é€è€…åï¿?

  // AIåˆ†æç»“æœï¼ˆä»…AIæ¶ˆæ¯æœ‰ï¼‰
  analysisData Json? @map("analysis_data") // AIåˆ†ææ•°æ®
  suggestions  Json? // AIå»ºè®®

  // æ—¶é—´ï¿?
  createdAt DateTime @default(now()) @map("created_at")

  // å…³è”å…³ç³»
  discussion IdeaDiscussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  @@map("discussion_messages")
}

// æ¶ˆæ¯ç±»å‹æšä¸¾
enum MessageType {
  INITIAL_ANALYSIS // åˆå§‹åˆ†æ
  CLARIFICATION_REQUEST // æ¾„æ¸…é—®é¢˜
  USER_RESPONSE // ç”¨æˆ·å›åº”
  IMPROVEMENT_SUGGESTION // æ”¹è¿›å»ºè®®
  FINAL_ASSESSMENT // æœ€ç»ˆè¯„ï¿?
}

// å‘é€è€…ç±»å‹æšï¿?
enum SenderType {
  USER // ç”¨æˆ·
  AI_AGENT // AIä¸“å®¶
}

// è®¢å•ï¿?
model Order {
  id     String @id @default(cuid())
  userId String @map("user_id")

  // è®¢å•ä¿¡æ¯
  amount      Float // è®¢å•é‡‘é¢
  currency    String      @default("CNY")
  description String // è®¢å•æè¿°
  status      OrderStatus @default(PENDING)

  // æ”¯ä»˜ä¿¡æ¯
  paymentMethod String? @map("payment_method") // æ”¯ä»˜æ–¹å¼
  paymentId     String? @map("payment_id") // å…³è”æ”¯ä»˜ID

  // æ—¶é—´ï¿?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  paidAt    DateTime? @map("paid_at")

  // å…³è”å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("orders")
}

// è®¢å•çŠ¶æ€æšï¿?
enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

// è´­ç‰©è½¦è¡¨
model CartItem {
  id      String @id @default(cuid())
  userId  String @map("user_id")
  agentId String @map("agent_id") // å…³è”çš„AI Agent ID

  // å•†å“ä¿¡æ¯
  price    Float? // ä»·æ ¼
  quantity Int    @default(1)

  // æ—¶é—´ï¿?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // å…³è”å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("cart_items")
}

// AI Agentï¿?
model Agent {
  id          String      @id @default(cuid())
  name        String // Agentåç§°
  description String // Agentæè¿°
  type        AgentType // Agentç±»å‹
  status      AgentStatus @default(ACTIVE)

  // å®šä»·ä¿¡æ¯
  price   Float? // ä»·æ ¼
  credits Int? // æ‰€éœ€ç§¯åˆ†

  // æ—¶é—´ï¿?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("agents")
}

// Agentç±»å‹æšä¸¾
enum AgentType {
  CREATIVE
  ANALYTICAL
  TECHNICAL
  BUSINESS
  MARKETING
}

// AgentçŠ¶æ€æšï¿?
enum AgentStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

// ÉÌÒµ¼Æ»®»á»°×´Ì¬
enum BusinessPlanSessionStatus {
  PENDING
  COMPLETED
  FAILED
}

// ÉÌÒµ¼Æ»®À´Ô´
enum BusinessPlanSource {
  AI_BIDDING
  MARKETPLACE
  API
  MANUAL
}

// ÉÌÒµ¼Æ»®»á»°
model BusinessPlanSession {
  id        String                     @id @default(cuid())
  userId    String?                    @map("user_id")
  ideaId    String?                    @map("idea_id")
  source    BusinessPlanSource         @default(AI_BIDDING)
  status    BusinessPlanSessionStatus  @default(PENDING)
  snapshot  Json
  expiresAt DateTime?                  @map("expires_at")
  createdAt DateTime                   @default(now()) @map("created_at")
  updatedAt DateTime                   @updatedAt @map("updated_at")

  user    User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  reports BusinessPlanReport[]
  audits  BusinessPlanAudit[]

  @@map("business_plan_sessions")
}

// ÉÌÒµ¼Æ»®±¨¸æ
model BusinessPlanReport {
  id        String              @id @default(cuid())
  sessionId String              @map("session_id")
  guide     Json
  version   Int                 @default(1)
  metadata  Json?
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")

  session BusinessPlanSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("business_plan_reports")
}

// ÉÌÒµ¼Æ»®Éó¼ÆÈÕÖ¾
model BusinessPlanAudit {
  id        String              @id @default(cuid())
  sessionId String              @map("session_id")
  action    String
  payload   Json?
  createdBy String?             @map("created_by")
  createdAt DateTime            @default(now()) @map("created_at")

  session BusinessPlanSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("business_plan_audits")
}

