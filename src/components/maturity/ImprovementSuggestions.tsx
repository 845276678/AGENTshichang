import React from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { TrendingUp, AlertCircle, CheckCircle } from 'lucide-react';
import type { MaturityScoreResult } from '@/types/maturity-score';

interface ImprovementSuggestionsProps {
  assessment: MaturityScoreResult;
}

/**
 * æ”¹è¿›å»ºè®®ç»„ä»¶
 * æ˜¾ç¤ºåŸºäºè–„å¼±ç»´åº¦çš„æ”¹è¿›å»ºè®®
 */
export function ImprovementSuggestions({ assessment }: ImprovementSuggestionsProps) {
  const { weakDimensions, dimensions, validSignals, invalidSignals, totalScore } = assessment;

  // å¦‚æœåˆ†æ•°å¾ˆé«˜ï¼ˆ>8åˆ†ï¼‰ï¼Œæ˜¾ç¤ºç¥è´ºä¿¡æ¯
  if (totalScore >= 8.0) {
    return (
      <Card className="bg-green-50 border-green-200">
        <CardContent className="pt-6">
          <div className="flex items-start gap-3">
            <CheckCircle className="w-6 h-6 text-green-600 flex-shrink-0 mt-1" />
            <div>
              <h4 className="font-semibold text-green-900 mb-2">
                ğŸ‰ æ‚¨çš„åˆ›æ„å·²éå¸¸æˆç†Ÿï¼
              </h4>
              <p className="text-sm text-green-800">
                åˆ›æ„è´¨é‡è¾¾åˆ°é«˜æ°´å¹³ï¼Œå¯ä»¥ç›´æ¥å‚åŠ æ‰€æœ‰å·¥ä½œåŠæˆ–ç”Ÿæˆåˆ›æ„å®ç°å»ºè®®ã€‚
                ç»§ç»­ä¿æŒè¿™ä¸ªæ°´å¹³ï¼Œç¥æ‚¨åˆ›ä¸šé¡ºåˆ©ï¼
              </p>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  }

  // ç”Ÿæˆæ”¹è¿›å»ºè®®
  const suggestions = generateSuggestions(assessment);

  return (
    <div className="space-y-4">
      <div className="flex items-center gap-2">
        <TrendingUp className="w-5 h-5 text-blue-600" />
        <h3 className="text-lg font-semibold">æ”¹è¿›å»ºè®®</h3>
        <Badge variant="secondary">{suggestions.length}æ¡</Badge>
      </div>

      <div className="space-y-3">
        {suggestions.map((suggestion, index) => (
          <Card
            key={index}
            className={`border-l-4 ${getPriorityBorderColor(suggestion.priority)}`}
          >
            <CardContent className="pt-4">
              <div className="flex items-start gap-3">
                <div className={`px-2 py-1 rounded text-xs font-semibold ${getPriorityBadgeColor(suggestion.priority)}`}>
                  {suggestion.priority === 'high' ? 'é«˜ä¼˜å…ˆçº§' : suggestion.priority === 'medium' ? 'ä¸­ä¼˜å…ˆçº§' : 'ä½ä¼˜å…ˆçº§'}
                </div>
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-2">
                    <span className="text-sm font-semibold text-gray-900">
                      {getDimensionLabel(suggestion.dimension)}
                    </span>
                    <Badge variant="outline" className="text-xs">
                      å½“å‰: {suggestion.currentScore.toFixed(1)}/10
                    </Badge>
                  </div>
                  <p className="text-sm text-gray-700 mb-2">
                    {suggestion.suggestion}
                  </p>
                  {suggestion.estimatedGain > 0 && (
                    <div className="flex items-center gap-1 text-xs text-green-600">
                      <TrendingUp className="w-3 h-3" />
                      <span>é¢„è®¡æå‡: +{suggestion.estimatedGain.toFixed(1)}åˆ†</span>
                    </div>
                  )}
                </div>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      {/* The Mom Test æç¤º */}
      {(invalidSignals.futurePromises > 3 || invalidSignals.generalities > 5) && (
        <Card className="bg-orange-50 border-orange-200">
          <CardContent className="pt-4">
            <div className="flex items-start gap-3">
              <AlertCircle className="w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5" />
              <div className="text-sm">
                <p className="font-semibold text-orange-900 mb-1">
                  âš ï¸ The Mom Test æç¤º
                </p>
                <p className="text-orange-800">
                  æ£€æµ‹åˆ°è¾ƒå¤šæ— æ•ˆä¿¡å·ï¼ˆæœªæ¥æ‰¿è¯º: {invalidSignals.futurePromises}æ¬¡ï¼Œæ³›æ³›è€Œè°ˆ: {invalidSignals.generalities}æ¬¡ï¼‰ã€‚
                  å»ºè®®èšç„¦äº<span className="font-semibold">å…·ä½“çš„è¿‡å»æ¡ˆä¾‹</span>å’Œ<span className="font-semibold">çœŸå®çš„ä»˜è´¹æ•°æ®</span>ã€‚
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}

/**
 * ç”Ÿæˆæ”¹è¿›å»ºè®®
 */
function generateSuggestions(assessment: MaturityScoreResult) {
  const { weakDimensions, dimensions, validSignals, invalidSignals } = assessment;
  const suggestions: Array<{
    dimension: string;
    currentScore: number;
    priority: 'high' | 'medium' | 'low';
    suggestion: string;
    estimatedGain: number;
  }> = [];

  // é’ˆå¯¹æ¯ä¸ªè–„å¼±ç»´åº¦ç”Ÿæˆå»ºè®®
  weakDimensions.forEach((dim) => {
    const dimScore = dimensions[dim as keyof typeof dimensions];

    if (dim === 'targetCustomer') {
      suggestions.push({
        dimension: dim,
        currentScore: dimScore.score,
        priority: 'high',
        suggestion: validSignals.userIntroductions === 0
          ? 'è¡¥å……5-10ä¸ªçœŸå®ç”¨æˆ·è®¿è°ˆè®°å½•ï¼Œæ˜ç¡®ç»†åˆ†äººç¾¤å’Œå…·ä½“ç—›ç‚¹'
          : 'è¿›ä¸€æ­¥ç»†åŒ–ç›®æ ‡ç”¨æˆ·ç”»åƒï¼ŒåŒ…æ‹¬å¹´é¾„ã€èŒä¸šã€æ”¶å…¥æ°´å¹³ç­‰',
        estimatedGain: 1.5
      });
    }

    if (dim === 'demandScenario') {
      suggestions.push({
        dimension: dim,
        currentScore: dimScore.score,
        priority: 'high',
        suggestion: validSignals.specificPast === 0
          ? 'æè¿°å…·ä½“çš„ä½¿ç”¨åœºæ™¯ï¼Œç”¨"ä¸Šå‘¨"ã€"ä¸Šæ¬¡"ç­‰å…·ä½“æ—¶é—´è¡¨è¾¾'
          : 'é‡åŒ–ç—›ç‚¹ï¼ˆå¦‚"æ¯å‘¨èŠ±2å°æ—¶"ï¼‰ï¼Œæä¾›æ›´å¤šçœŸå®æ¡ˆä¾‹',
        estimatedGain: 1.2
      });
    }

    if (dim === 'coreValue') {
      suggestions.push({
        dimension: dim,
        currentScore: dimScore.score,
        priority: 'medium',
        suggestion: validSignals.painPoints === 0
          ? 'æŒ–æ˜æ›´å¤šç”¨æˆ·ç—›ç‚¹æ•…äº‹ï¼ˆå¦‚"ä¸¢äº†å®¢æˆ·"ã€"æŸå¤±XXå…ƒ"ï¼‰'
          : 'è¯´æ˜ä¸ç«å“çš„å…·ä½“å·®å¼‚åŒ–ä¼˜åŠ¿ï¼Œå¼ºåŒ–ç‹¬ç‰¹ä»·å€¼',
        estimatedGain: 1.0
      });
    }

    if (dim === 'businessModel') {
      suggestions.push({
        dimension: dim,
        currentScore: dimScore.score,
        priority: 'high',
        suggestion: validSignals.realSpending === 0
          ? 'éªŒè¯ç”¨æˆ·ä»˜è´¹æ„æ„¿ï¼Œæä¾›çœŸå®ä»˜è´¹æ¡ˆä¾‹æˆ–MVPæµ‹è¯•æ•°æ®'
          : 'è¡¥å……æ›´å¤šå•†ä¸šæ•°æ®ï¼ˆè½¬åŒ–ç‡ã€å®¢å•ä»·ã€è·å®¢æˆæœ¬ç­‰ï¼‰',
        estimatedGain: 1.8
      });
    }

    if (dim === 'credibility') {
      suggestions.push({
        dimension: dim,
        currentScore: dimScore.score,
        priority: 'medium',
        suggestion: validSignals.evidence === 0
          ? 'æä¾›å¯éªŒè¯è¯æ®ï¼šè®¿è°ˆè®°å½•æˆªå›¾ã€æ•°æ®æˆªå›¾ã€äº§å“é“¾æ¥ç­‰'
          : 'è¡¥å……æ›´å¤šå®¢è§‚æŒ‡æ ‡ï¼ˆç•™å­˜ç‡ã€å¢é•¿ç‡ã€ç”¨æˆ·è¯„ä»·ç­‰ï¼‰',
        estimatedGain: 1.5
      });
    }
  });

  // æŒ‰ä¼˜å…ˆçº§å’Œé¢„æœŸæå‡æ’åº
  suggestions.sort((a, b) => {
    const priorityOrder = { high: 3, medium: 2, low: 1 };
    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
      return priorityOrder[b.priority] - priorityOrder[a.priority];
    }
    return b.estimatedGain - a.estimatedGain;
  });

  return suggestions;
}

/**
 * ç»´åº¦æ ‡ç­¾æ˜ å°„
 */
function getDimensionLabel(dimension: string): string {
  const labels: Record<string, string> = {
    targetCustomer: 'ç›®æ ‡å®¢æˆ·',
    demandScenario: 'éœ€æ±‚åœºæ™¯',
    coreValue: 'æ ¸å¿ƒä»·å€¼',
    businessModel: 'å•†ä¸šæ¨¡å¼',
    credibility: 'å¯ä¿¡åº¦'
  };
  return labels[dimension] || dimension;
}

/**
 * ä¼˜å…ˆçº§è¾¹æ¡†é¢œè‰²
 */
function getPriorityBorderColor(priority: string): string {
  if (priority === 'high') return 'border-red-500';
  if (priority === 'medium') return 'border-yellow-500';
  return 'border-gray-300';
}

/**
 * ä¼˜å…ˆçº§å¾½ç« é¢œè‰²
 */
function getPriorityBadgeColor(priority: string): string {
  if (priority === 'high') return 'bg-red-100 text-red-800';
  if (priority === 'medium') return 'bg-yellow-100 text-yellow-800';
  return 'bg-gray-100 text-gray-800';
}
